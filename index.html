<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EKELEC - GESTION CHANTIER</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
.glass { background: #1e293b; border: 1px solid #334155; border-radius: 20px; transition:0.3s; }
input, select { background: #0f172a !important; border: 1px solid #475569 !important; color: white !important; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; outline: none; }
.btn-gold { background: #f59e0b; color: black; font-weight: bold; text-transform: uppercase; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.3s; border:none; }
.btn-gold:hover { background: #fbbf24; transform: translateY(-2px); }

#printArea { display: none; }
@media print {
    @page { margin: 0.8cm; size: auto; }
    html, body { height: auto; overflow: visible; background: white !important; }
    #app, #loginPage, #modalCode, footer { display: none !important; }
    #printArea { display: block !important; position: relative; width: 100%; background: white !important; color: black !important; padding: 0; margin: 0; }
    .report-header { border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #f1f5f9 !important; border: 1px solid #000; padding: 8px; font-size: 10px; color: #000 !important; }
    td { border: 1px solid #000; padding: 6px; font-size: 10px; color: #000 !important; }
    
    .txt-left { text-align: left !important; }
    .num-right { text-align: right !important; }
    
    .total-box { border: 2px solid #000; padding: 10px; margin-top: 5px; text-align: right; font-size: 14px; font-weight: 900; color: #000 !important; background: #f8fafc !important; }
    .sig-grid { display: flex; justify-content: space-between; margin-top: 40px; }
    .sig-b { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; font-weight: bold; color: black; }
}
</style>
</head>
<body onkeydown="if(event.key==='Enter') validerParEntree()">

<div id="loginPage" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-950">
    <div class="glass p-10 w-full max-w-md text-center shadow-2xl">
        <h1 class="text-5xl font-black text-amber-500 mb-2 italic tracking-tighter">EKELEC</h1>
        <p class="text-[10px] text-slate-400 uppercase font-black mb-8 tracking-[3px]">Gestion de Chantier Pro</p>
        <input type="text" id="userGerant" value="EKELEC" class="text-center mb-2 uppercase font-bold border-amber-500/30">
        <input type="password" id="passAccess" placeholder="CODE ACCÈS" class="text-center text-2xl tracking-[10px]">
        <button onclick="checkLogin()" class="btn-gold mt-4 shadow-xl w-full">OUVRIR LA SESSION</button>
        <p class="text-[9px] mt-6 text-slate-600 font-bold uppercase">Conçu par Diaby Mohamed & Gemini</p>
    </div>
</div>

<div id="app" class="hidden flex-grow">
    <nav class="p-4 glass m-2 flex justify-between items-center sticky top-0 z-50 shadow-lg">
        <div class="flex flex-col leading-none">
            <div class="font-black text-amber-500 text-xl italic flex items-center gap-2">
                <i class="fa-solid fa-bolt"></i> EKELEC
            </div>
            <span id="displayGerant" class="text-[9px] font-black uppercase text-slate-400 mt-1 opacity-70">GÉRANT : </span>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="openModal('modalCode')" class="text-amber-500 text-xl"><i class="fa-solid fa-key"></i></button>
            <button onclick="exportData()" class="text-blue-400 text-xl"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            <input type="file" id="importFile" onchange="importData()" class="hidden">
            <button onclick="document.getElementById('importFile').click()" class="text-yellow-400 text-xl"><i class="fa-solid fa-upload"></i></button>
            <button onclick="location.reload()" class="text-red-500 text-xl"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div class="p-4 max-w-6xl mx-auto">
        <div id="viewAccueil">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-[10px] font-black uppercase tracking-[3px] text-slate-500">Tableau de bord</h2>
                <button onclick="printGlobalReport()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase flex items-center gap-2 border border-slate-500">
                    <i class="fa-solid fa-print"></i> Bilan Global
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-4 border-b-4 border-blue-500"><p class="text-[9px] uppercase font-black text-slate-400">Projets</p><p id="statTotalChantiers" class="text-2xl font-black text-white">0</p></div>
                <div class="glass p-4 border-b-4 border-emerald-500"><p class="text-[9px] uppercase font-black text-slate-400">Total Reçu</p><p id="statTotalRecu" class="text-xl font-black text-emerald-400">0</p></div>
                <div class="glass p-4 border-b-4 border-red-500"><p class="text-[9px] uppercase font-black text-slate-400">Total Dépensé</p><p id="statTotalDepense" class="text-xl font-black text-red-400">0</p></div>
                <div class="glass p-4 border-b-4 border-amber-500"><p class="text-[9px] uppercase font-black text-slate-400">Solde Global</p><p id="statTotalSolde" class="text-xl font-black text-amber-500">0</p></div>
            </div>
            <div class="flex justify-between items-center mb-6 gap-4">
                <input type="text" id="searchHome" oninput="renderHome()" placeholder="Rechercher un chantier..." class="max-w-xs mb-0">
                <button onclick="openModal('modalChantier')" class="bg-amber-500 text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">+ Nouveau Projet</button>
            </div>
            <div id="listeChantiers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewProjet" class="hidden">
            <button onclick="goHome()" class="text-slate-400 mb-6 text-[10px] font-black uppercase flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> Retour</button>
            <div class="glass p-8 mb-6 border-l-[12px] border-amber-500 shadow-2xl relative">
                <h1 id="chantierTitre" class="text-3xl font-black text-amber-500 uppercase italic mb-2"></h1>
                <p id="chantierInfos" class="text-[11px] opacity-60 font-bold uppercase mb-6"></p>
                <div class="flex gap-3">
                    <button onclick="openSaisie()" class="bg-emerald-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase">Nouvelle Saisie</button>
                    <button onclick="printReport()" class="bg-blue-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase">Imprimer Rapport</button>
                </div>
                <div class="absolute right-8 top-8 text-right">
                    <p class="text-[10px] uppercase font-black opacity-30">Solde Caisse</p>
                    <p id="soldeChantier" class="text-4xl font-black text-emerald-400">0 GNF</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 glass p-5">
                    <h3 class="text-[11px] font-black text-amber-500 uppercase mb-5">Suivi Personnel</h3>
                    <div id="listeOuvriers" class="space-y-4"></div>
                </div>
                <div class="lg:col-span-3 glass overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-slate-800 text-slate-400 uppercase">
                            <tr><th class="p-5">Opération</th><th class="p-5">Entrée</th><th class="p-5">Sortie</th><th class="p-5 text-center">Gestion</th></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-700/50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-center p-8 opacity-40">
        <p class="text-[10px] font-black tracking-[2px] uppercase">EKELEC v9.9.8 — Conçu par Diaby Mohamed & Gemini</p>
    </footer>
</div>

<div id="modalSaisie" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-[100]">
    <div class="glass p-10 w-full max-w-md">
        <h3 class="font-black mb-4 uppercase text-amber-500">Saisie de Flux</h3>
        <input type="hidden" id="editIndex">
        <select id="typeSaisie" onchange="toggleForm()" class="font-bold">
            <option value="DIVERS">DIVERS (Caisse)</option>
            <option value="ARTICLE">ARTICLE (Matériaux)</option>
            <option value="OUVRIER">OUVRIER (Main d'œuvre)</option>
        </select>
        <select id="fCat" class="font-bold">
            <option value="GENERAL">Général</option>
            <option value="ELECTRICITE">Électricité</option>
            <option value="PLOMBERIE">Plomberie</option>
            <option value="MACONNERIE">Maçonnerie</option>
        </select>
        <div id="formD"><input type="text" id="fMotif" placeholder="Désignation"><div class="grid grid-cols-2 gap-2"><input type="number" id="fE" placeholder="Reçu"><input type="number" id="fS" placeholder="Payé"></div></div>
        <div id="formA" class="hidden"><input type="text" id="fArtNom" placeholder="Nom article"><div class="grid grid-cols-2 gap-2"><input type="number" id="fArtP" placeholder="Prix Unit."><input type="number" id="fArtQ" placeholder="Quantité"></div></div>
        <div id="formO" class="hidden"><input type="text" id="fOuvNom" placeholder="Nom ouvrier" oninput="trouverOuvrier(this.value)"><input type="text" id="fOuvJob" placeholder="Métier"><input type="number" id="fOuvC" placeholder="Contrat"><input type="number" id="fOuvA" placeholder="Paiement"></div>
        <input type="date" id="fDate">
        <div class="grid grid-cols-2 gap-3 mt-6">
            <button onclick="saveEntry(true)" class="bg-emerald-600 p-4 rounded-lg uppercase text-[10px] font-black">Suivant</button>
            <button onclick="saveEntry(false)" class="btn-gold">Valider</button>
        </div>
        <button onclick="closeModal('modalSaisie')" class="w-full mt-4 text-[10px] opacity-40 uppercase">Annuler</button>
    </div>
</div>

<div id="modalChantier" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-[100]">
    <div class="glass p-10 w-full max-w-md">
        <h3 class="font-black mb-6 uppercase text-amber-500">Nouveau Projet</h3>
        <input type="text" id="cNom" placeholder="NOM DU CHANTIER"><input type="text" id="cLieu" placeholder="LOCALISATION"><input type="text" id="cClient" placeholder="NOM DU CLIENT">
        <button onclick="createChantier()" class="btn-gold w-full mt-4">CRÉER</button>
        <button onclick="closeModal('modalChantier')" class="w-full mt-4 text-[10px] opacity-40 uppercase">Annuler</button>
    </div>
</div>

<div id="modalCode" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-[200]">
    <div class="glass p-10 w-full max-w-md text-center">
        <h3 class="font-black mb-6 uppercase text-amber-500">Nouveau Code Accès</h3>
        <input type="password" id="newCode" placeholder="ENTREZ LE NOUVEAU CODE" class="text-center text-2xl">
        <button onclick="changeCode()" class="btn-gold w-full mt-4">SAUVEGARDER</button>
        <button onclick="closeModal('modalCode')" class="w-full mt-4 text-[10px] opacity-40 uppercase">Annuler</button>
    </div>
</div>

<div id="printArea"><div id="printContent"></div></div>

<script>
let db = JSON.parse(localStorage.getItem('PRO_DB_V9')) || [];
let config = JSON.parse(localStorage.getItem('PRO_CONFIG')) || { code: "1234" };
let currentId = null;

function checkLogin(){
    const gerant = document.getElementById('userGerant').value;
    const pass = document.getElementById('passAccess').value;
    if(pass === config.code && gerant.trim() !== "") {
        document.getElementById('displayGerant').innerText = "GÉRANT : " + gerant.toUpperCase();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderHome();
    } else { alert("CODE ACCÈS INCORRECT"); }
}

function renderHome(){
    const div = document.getElementById('listeChantiers');
    const search = document.getElementById('searchHome').value.toLowerCase();
    div.innerHTML = ""; let gRecu = 0, gDepense = 0;
    db.forEach((c,i)=>{
        let inT=0, outT=0; c.flux.forEach(f=>{ inT+=f.e; outT+=f.s; });
        gRecu += inT; gDepense += outT;
        if(c.nom.toLowerCase().includes(search)){
            div.innerHTML += `<div class="glass p-6 cursor-pointer hover:border-amber-500 border border-transparent" onclick="openProject(${i})">
                <h3 class="text-xl font-black text-amber-500 uppercase italic leading-tight">${c.nom}</h3>
                <div class="mt-4 text-[10px] font-black uppercase">
                    <div class="flex justify-between mb-1"><span>Reçu:</span><span class="text-emerald-400">${inT.toLocaleString()} GNF</span></div>
                    <div class="flex justify-between"><span>Dépense:</span><span class="text-red-400">${outT.toLocaleString()} GNF</span></div>
                </div>
            </div>`;
        }
    });
    document.getElementById('statTotalChantiers').innerText = db.length;
    document.getElementById('statTotalRecu').innerText = gRecu.toLocaleString() + " GNF";
    document.getElementById('statTotalDepense').innerText = gDepense.toLocaleString() + " GNF";
    document.getElementById('statTotalSolde').innerText = (gRecu-gDepense).toLocaleString() + " GNF";
}

function renderJournal(){
    const c = db[currentId]; const tbody = document.getElementById('tableBody'); const lOuv = document.getElementById('listeOuvriers');
    tbody.innerHTML = ""; lOuv.innerHTML = ""; let workers = {}; let solde = 0;
    c.flux.forEach((f,idx)=>{
        solde += (f.e - f.s);
        if(f.type==='OUVRIER'){ if(!workers[f.on]) workers[f.on]={job:f.oj, contrat:f.oc, paye:0}; workers[f.on].paye += f.s; }
        tbody.innerHTML += `<tr><td class="p-5 font-bold uppercase">${f.txt}<br><span class="opacity-30 text-[9px]">${f.date}</span></td><td class="p-5 text-emerald-400 font-black">${f.e>0?f.e.toLocaleString():'-'}</td><td class="p-5 text-red-400 font-black">${f.s>0?f.s.toLocaleString():'-'}</td><td class="p-5 text-center flex gap-4 justify-center"><button onclick="editEntry(${idx})" class="text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteEntry(${idx})" class="text-slate-600"><i class="fa-solid fa-trash"></i></button></td></tr>`;
    });
    document.getElementById('soldeChantier').innerText = solde.toLocaleString() + " GNF";
    for(let n in workers){
        let r = workers[n].contrat - workers[n].paye;
        lOuv.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-xl border-l-4 border-amber-500">
            <div class="flex justify-between items-center mb-2"><span class="font-black text-[10px] uppercase">${n}</span>
                <div class="flex gap-2">
                    <button onclick="payerOuvrierExistant('${n}')" title="Payer" class="text-amber-500 text-xs"><i class="fa-solid fa-circle-plus"></i></button>
                    <button onclick="sendWA('${n}')" title="WhatsApp" class="text-emerald-500 text-xs"><i class="fa-brands fa-whatsapp"></i></button>
                    <button onclick="printRecu('${n}')" title="Reçu" class="text-white opacity-40 text-xs"><i class="fa-solid fa-print"></i></button>
                </div>
            </div>
            <div class="flex justify-between"><span class="text-[9px] opacity-30">RESTE</span><span class="font-black text-xs ${r<=0?'text-emerald-400':'text-red-400'}">${r.toLocaleString()} GNF</span></div></div>`;
    }
}

function payerOuvrierExistant(nom) {
    const worker = db[currentId].flux.find(f => f.on === nom);
    if(worker) {
        openSaisie();
        document.getElementById('typeSaisie').value = 'OUVRIER';
        toggleForm();
        document.getElementById('fOuvNom').value = worker.on;
        document.getElementById('fOuvJob').value = worker.oj;
        document.getElementById('fOuvC').value = worker.oc;
        document.getElementById('fOuvA').value = "";
        document.getElementById('fOuvA').focus();
    }
}

function printReport() {
    const c = db[currentId]; let ti = 0, to = 0, soldeC = 0; let workers = {};
    const gerant = document.getElementById('userGerant').value.toUpperCase();
    
    c.flux.forEach(f => {
        if(f.type==='OUVRIER'){
            if(!workers[f.on]) workers[f.on] = {contrat: f.oc, paye: 0};
            workers[f.on].paye += f.s;
        }
    });

    let h = `<div style="padding:30px; background:#fff; color:#000">
        <div class="report-header">
            <div class="txt-left"><h2 style="font-size:18px; font-weight:900">RAPPORT : ${c.nom.toUpperCase()}</h2><span>CLIENT : ${c.client || 'N/A'}</span></div>
            <div style="text-align:right"><span>DATE : ${new Date().toLocaleDateString()}</span><br><span>GÉRANT : ${gerant}</span></div>
        </div>
        <table><thead><tr><th class="txt-left">DATE</th><th class="txt-left">LIBELLÉ</th><th class="num-right">ENTRÉE</th><th class="num-right">SORTIE</th><th class="num-right">SOLDE</th></tr></thead><tbody>`;
    c.flux.forEach(f => {
        ti += f.e; to += f.s; soldeC += (f.e - f.s);
        h += `<tr><td class="txt-left">${f.date}</td><td class="txt-left">${f.txt}</td><td class="num-right">${f.e>0?f.e.toLocaleString():'-'}</td><td class="num-right">${f.s>0?f.s.toLocaleString():'-'}</td><td class="num-right" style="background:#f8fafc"><b>${soldeC.toLocaleString()}</b></td></tr>`;
    });
    h += `</tbody></table>
        <div class="total-box">TOTAL DÉPENSÉ : ${to.toLocaleString()} GNF</div>
        <div class="total-box" style="border-top:none">SOLDE NET EN CAISSE : ${(ti-to).toLocaleString()} GNF</div>`;

    h += `<h3 style="margin-top:20px; font-size:12px; border-bottom:1px solid #000; text-transform:uppercase" class="txt-left">Situation Main d'œuvre</h3>
        <table style="margin-top:5px"><thead><tr><th class="txt-left">OUVRIER</th><th class="num-right">CONTRAT</th><th class="num-right">PAYÉ</th><th class="num-right">RESTE</th></tr></thead><tbody>`;
    for(let n in workers){
        let r = workers[n].contrat - workers[n].paye;
        h += `<tr><td class="txt-left">${n}</td><td class="num-right">${workers[n].contrat.toLocaleString()}</td><td class="num-right">${workers[n].paye.toLocaleString()}</td><td class="num-right" style="color:${r>0?'red':'green'}"><b>${r.toLocaleString()}</b></td></tr>`;
    }
    h += `</tbody></table>
        <div style="margin-top:20px; text-align:center; font-size:10px; opacity:0.5 italic">Rapport généré le ${new Date().toLocaleString()}</div>
        <div class="sig-grid"><div class="sig-b">Signature Gérant</div><div class="sig-b">Signature Client</div></div></div>`;
    
    document.getElementById('printContent').innerHTML = h; window.print();
}

function printGlobalReport() {
    let gRecu = 0, gDepense = 0;
    let h = `<div style="padding:30px; background:#fff; color:#000; font-family:sans-serif">
        <h2 style="text-align:center; border-bottom:3px solid #000; padding-bottom:10px; text-transform:uppercase">Bilan Global des Chantiers</h2>
        <p style="text-align:right">Date: ${new Date().toLocaleDateString()}</p>
        <table style="width:100%; border-collapse:collapse; margin-top:20px">
            <thead><tr style="background:#f1f5f9">
                <th style="border:1px solid #000; padding:10px" class="txt-left">CHANTIER</th>
                <th style="border:1px solid #000; padding:10px" class="num-right">TOTAL REÇU</th>
                <th style="border:1px solid #000; padding:10px" class="num-right">TOTAL DÉPENSÉ</th>
                <th style="border:1px solid #000; padding:10px" class="num-right">SOLDE CAISSE</th>
            </tr></thead><tbody>`;
    db.forEach(c => {
        let inT = 0, outT = 0;
        c.flux.forEach(f => { inT += f.e; outT += f.s; });
        gRecu += inT; gDepense += outT;
        h += `<tr>
            <td style="border:1px solid #000; padding:8px" class="txt-left"><b>${c.nom.toUpperCase()}</b></td>
            <td style="border:1px solid #000; padding:8px" class="num-right">${inT.toLocaleString()}</td>
            <td style="border:1px solid #000; padding:8px" class="num-right">${outT.toLocaleString()}</td>
            <td style="border:1px solid #000; padding:8px; background:#f8fafc" class="num-right"><b>${(inT-outT).toLocaleString()}</b></td>
        </tr>`;
    });
    h += `</tbody></table>
        <div style="margin-top:20px; text-align:right; font-size:18px">
            <p>TOTAL GÉNÉRAL REÇU : <b>${gRecu.toLocaleString()} GNF</b></p>
            <p>TOTAL GÉNÉRAL DÉPENSÉ : <b>${gDepense.toLocaleString()} GNF</b></p>
            <p style="text-decoration:underline; font-size:22px">SOLDE GLOBAL DISPONIBLE : <b>${(gRecu-gDepense).toLocaleString()} GNF</b></p>
        </div></div>`;
    document.getElementById('printContent').innerHTML = h; window.print();
}

function printRecu(nom) {
    const c = db[currentId]; let ctr = 0, pyeTotal = 0, job="";
    let historique = ""; 
    
    c.flux.forEach(f => { 
        if(f.on === nom) { 
            ctr = f.oc; 
            job = f.oj;
            if(f.s > 0) {
                pyeTotal += f.s;
                historique += `<tr><td class="txt-left">${f.date}</td><td class="num-right">${f.s.toLocaleString()} GNF</td></tr>`;
            }
        } 
    });

    let h = `<div style="padding:50px; border:2px solid #000; background:#fff; color:#000; text-align:center">
        <h2 style="text-decoration:underline; margin-top:0">REÇU D'ACOMPTE(S) & SITUATION</h2>
        <div style="margin:40px 0; text-align:left; font-size:16px; line-height:1.6">
            Je soussigné, <b>${nom.toUpperCase()}</b> (${job}), reconnaît avoir reçu les montants suivants pour les travaux sur le chantier <b>${c.nom.toUpperCase()}</b> :<br><br>
            
            <table style="width:100%; margin-bottom:20px;">
                <thead style="background:#f1f5f9;"><tr><th class="txt-left">DATE DU PAIEMENT</th><th class="num-right">MONTANT VERSÉ</th></tr></thead>
                <tbody>${historique}</tbody>
            </table>

            <table style="width:100%; border:none; margin-top:20px; border-top:1px solid #000; padding-top:10px;">
                <tr><td style="border:none;" class="txt-left">MONTANT TOTAL DU CONTRAT :</td><td style="border:none;" class="num-right"><b>${ctr.toLocaleString()} GNF</b></td></tr>
                <tr><td style="border:none;" class="txt-left">CUMUL TOTAL DES ACOMPTES :</td><td style="border:none;" class="num-right"><b>${pyeTotal.toLocaleString()} GNF</b></td></tr>
            </table>
            
            <div style="border:2px solid #000; padding:10px; margin-top:20px; font-size:24px; text-align:center">
                RESTE À PERCEVOIR : ${(ctr-pyeTotal).toLocaleString()} GNF
            </div>
        </div>
        <div class="sig-grid" style="margin-top:60px"><div class="sig-b">L'Ouvrier (Signature)</div><div class="sig-b">Le Gérant</div></div></div>`;
    document.getElementById('printContent').innerHTML = h; window.print();
}

function saveEntry(keepOpen) {
    const idx = document.getElementById('editIndex').value; const type = document.getElementById('typeSaisie').value;
    let entry = { type: type, date: document.getElementById('fDate').value, cat: document.getElementById('fCat').value, e: 0, s: 0, txt: "", oc: 0, on: "", oj: "" };
    if(type === 'DIVERS') { entry.e = parseFloat(document.getElementById('fE').value) || 0; entry.s = parseFloat(document.getElementById('fS').value) || 0; entry.txt = document.getElementById('fMotif').value || "Divers"; }
    else if(type === 'ARTICLE') { let p = parseFloat(document.getElementById('fArtP').value) || 0, q = parseFloat(document.getElementById('fArtQ').value) || 0; entry.s = p * q; entry.txt = `MATÉRIEL : ${document.getElementById('fArtNom').value.toUpperCase()} (x${q})`; }
    else { 
        entry.on = document.getElementById('fOuvNom').value.trim(); entry.oj = document.getElementById('fOuvJob').value; 
        entry.oc = parseFloat(document.getElementById('fOuvC').value) || 0; entry.s = parseFloat(document.getElementById('fOuvA').value) || 0; 
        entry.txt = `PAYE : ${entry.on.toUpperCase()}`;
        db[currentId].flux.forEach(f => { if(f.on === entry.on) { f.oc = entry.oc; f.oj = entry.oj; } });
    }
    if(idx !== "") db[currentId].flux[idx] = entry; else db[currentId].flux.push(entry);
    saveDB(); renderJournal();
    if(keepOpen) { viderSaisie(); document.getElementById('fDate').valueAsDate = new Date(); } else { closeModal('modalSaisie'); }
}

function openProject(i){ currentId = i; document.getElementById('viewAccueil').classList.add('hidden'); document.getElementById('viewProjet').classList.remove('hidden'); document.getElementById('chantierTitre').innerText = db[i].nom; document.getElementById('chantierInfos').innerText = `${db[i].lieu} | CLIENT : ${db[i].client}`; renderJournal(); }
function goHome() { document.getElementById('viewAccueil').classList.remove('hidden'); document.getElementById('viewProjet').classList.add('hidden'); renderHome(); }
function saveDB() { localStorage.setItem('PRO_DB_V9', JSON.stringify(db)); }
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('editIndex').value=""; }
function toggleForm() { const v = document.getElementById('typeSaisie').value; document.getElementById('formD').className = v === 'DIVERS' ? '' : 'hidden'; document.getElementById('formA').className = v === 'ARTICLE' ? '' : 'hidden'; document.getElementById('formO').className = v === 'OUVRIER' ? '' : 'hidden'; }
function trouverOuvrier(nom) { if(nom.length < 2) return; const found = db[currentId].flux.find(f => f.on && f.on.toLowerCase().includes(nom.toLowerCase())); if(found) { document.getElementById('fOuvJob').value = found.oj; document.getElementById('fOuvC').value = found.oc; } }
function createChantier() { const n = document.getElementById('cNom').value; if(n) { db.push({ nom: n, lieu: document.getElementById('cLieu').value, client: document.getElementById('cClient').value, flux: [] }); saveDB(); closeModal('modalChantier'); renderHome(); } }
function editEntry(idx) { 
    const f = db[currentId].flux[idx]; document.getElementById('editIndex').value = idx;
    document.getElementById('typeSaisie').value = f.type; document.getElementById('fCat').value = f.cat || 'GENERAL'; toggleForm();
    document.getElementById('fDate').value = f.date;
    if(f.type==='DIVERS'){ document.getElementById('fMotif').value=f.txt; document.getElementById('fE').value=f.e; document.getElementById('fS').value=f.s; }
    else if(f.type==='ARTICLE'){ document.getElementById('fArtNom').value=f.txt.replace('MATÉRIEL : ','').split(' (')[0]; let parts = f.txt.match(/\(x(\d+)\)/); let q = parts ? parseInt(parts[1]) : 1; document.getElementById('fArtQ').value = q; document.getElementById('fArtP').value = f.s / q; }
    else { document.getElementById('fOuvNom').value=f.on; document.getElementById('fOuvJob').value=f.oj; document.getElementById('fOuvC').value=f.oc; document.getElementById('fOuvA').value=f.s; }
    openModal('modalSaisie');
}

function deleteEntry(idx) { 
    const ligne = db[currentId].flux[idx];
    const montant = (ligne.e > 0) ? ligne.e : ligne.s;
    if(confirm(`SÉCURITÉ\n\nSupprimer cette opération de ${montant.toLocaleString()} GNF ?`)){ 
        db[currentId].flux.splice(idx,1); saveDB(); renderJournal(); 
    } 
}

function exportData() { const blob = new Blob([JSON.stringify(db)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SAUVEGARDE_EKELEC_${new Date().toLocaleDateString()}.json`; a.click(); }
function importData() { const file = document.getElementById('importFile').files[0]; const reader = new FileReader(); reader.onload = e => { db = JSON.parse(e.target.result); saveDB(); renderHome(); }; reader.readAsText(file); }
function openSaisie() { document.getElementById('editIndex').value = ""; viderSaisie(); openModal('modalSaisie'); }
function viderSaisie() { document.querySelectorAll('#modalSaisie input').forEach(i => i.value=""); document.getElementById('fDate').valueAsDate = new Date(); }
function sendWA(nom) { const c = db[currentId]; let ctr = 0, pye = 0; c.flux.forEach(f => { if(f.on === nom) { ctr = f.oc; pye += f.s; } }); window.open(`https://wa.me/?text=*INFOS PAIEMENT*%0AChantier : ${c.nom.toUpperCase()}%0AOuvrier : ${nom.toUpperCase()}%0AReste à percevoir : ${(ctr-pye).toLocaleString()} GNF`, '_blank'); }
function changeCode() { const n = document.getElementById('newCode').value; if(n) { config.code = n; localStorage.setItem('PRO_CONFIG', JSON.stringify(config)); alert("CODE MODIFIÉ AVEC SUCCÈS"); closeModal('modalCode'); } }
function validerParEntree() { if (!document.getElementById('loginPage').classList.contains('hidden')) { checkLogin(); } }
document.getElementById('fDate').valueAsDate = new Date();
</script>
</body>
</html>
