<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EKELEC V1.0.0.4</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
/* THEME KAKI / NOIR / BLANC */
body { background: #0a0a0a; color: #f4f4f4; font-family: 'Arial Narrow', sans-serif !important;
font-size: 14px !important; /* Pour respecter la taille 14 demandée */ 
}
input, select, button { 
    font-family: 'Arial Narrow', sans-serif !important; 
}
/* Permet de fixer le haut et de scroller uniquement le contenu */
/* 1. La barre du haut : on la colle vraiment au plafond */
.sticky-header {
    position: sticky;
    top: 0; 
    z-index: 50;
    background: #0a0a0a;
    padding-bottom: 10px;
}

/* 2. Le titre du projet : on l'ajuste pour qu'il ne glisse pas dessous */
.sticky-projet-header {
    position: sticky;
    top: 55px; /* On le descend pour qu'il soit bien sous le menu */
    z-index: 40;
    background: #0a0a0a;
    padding-top: 10px;
    padding-bottom: 15px;
}

/* Optionnel : pour rendre le scroll plus fluide sur mobile */
#listeChantiers, #listeArchives {
    overflow-y: visible;
}
.glass { 
    background: #171717; 
    border: 1px solid #262626; 
    border-radius: 20px; 
    transition: 0.3s;
    margin-bottom: 15px; /* Cela crée l'espace entre tes cadres */
}
input, select { background: #0a0a0a !important; border: 1px solid #3f3f3f !important; color: white !important; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; outline: none; }
.btn-gold { background: #6b705c; color: white; font-weight: bold; text-transform: uppercase; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.3s; border:none; }
.btn-gold:hover { background: #a5a58d; transform: translateY(-2px); }
#logoPreview, #signPreview { max-width: 120px; max-height: 120px; margin: 0 auto 15px; display: block; object-fit: contain; }
@media (max-width: 768px) {
    #viewProjet .glass.p-8 { position: relative; padding: 20px !important; }
    #chantierTitre { font-size: 1.5rem !important; line-height: 1.2 !important; margin-bottom: 10px !important; }
    #viewProjet .absolute.right-8.top-8 { position: static !important; text-align: left !important; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    #soldeChantier { font-size: 1.8rem !important; }
}
#printArea { display: none; }
@media print {
    @page { margin: 0.8cm; size: auto; }
    html, body { height: auto; overflow: visible; background: white !important; }
    #app, #loginPage, #modalCode { display: none !important; }
    #printArea { display: block !important; position: relative; width: 100%; background: white !important; color: black !important; padding: 0; margin: 0; }
    .report-header { border-bottom: 4px solid #6b705c; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
    .report-title { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #000; margin-bottom: 5px; }
    .recu-ouvrier-title { font-size: 16px !important; border-bottom: 2px solid #000; display: inline-block; margin-bottom: 10px; }
    .info-block { line-height: 1.6; }
    .info-line { font-size: 13px; color: #000 !important; margin-bottom: 4px; display: block; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #f1f5f9 !important; border: 1px solid #000; padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; color: #000 !important; }
    td { border: 1px solid #cbd5e1; padding: 6px; font-size: 10px; color: #000 !important; }
    .row-entree { background-color: #f0fdf4 !important; }
    .row-sortie { background-color: #fef2f2 !important; }
    .total-box { border: 2px solid #000; padding: 8px; margin-top: 4px; text-align: right; font-size: 13px; font-weight: 900; background: #f8fafc !important; color: #000 !important; }
    .total-depense-rouge { color: #dc2626 !important; border-color: #dc2626 !important; }
    .cat-badge { font-size: 8px; text-transform: uppercase; background: #eee; padding: 2px 4px; border-radius: 3px; color: #666; font-weight: bold; }
    .signature-area { margin-top: 20px; text-align: right; page-break-inside: avoid; }
    .signature-area img { max-width: 120px; max-height: 100px; display: inline-block; object-fit: contain; }
}
@keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.alert-pulse { animation: pulse-red 1s infinite; }
</style>
</head>
<body onkeydown="if(event.key==='Enter') validerParEntree()">

<div id="loginPage" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black">
    <div class="glass p-10 w-full max-w-md text-center shadow-2xl">
        <img id="loginLogo" src="" class="mx-auto mb-6 h-24 w-24 object-contain rounded-xl shadow-lg border border-[#6b705c]/20">
        <p class="text-[10px] text-gray-500 uppercase font-black mb-4 tracking-[3px]">Accès Gestionnaire</p>
        <input type="text" id="userGerant" value="EKELEC" class="text-center mb-2 uppercase font-bold border-[#6b705c]/30" autocomplete="off">
        <input type="password" id="passAccess" placeholder="CODE ACCÈS" class="text-center text-2xl tracking-[10px]" autocomplete="new-password">
        <button onclick="checkLogin()" class="btn-gold mt-4 shadow-xl w-full">OUVRIR LA SESSION</button>
    </div>
</div>

<div id="app" class="hidden">
    <nav class="p-4 glass m-2 flex justify-between items-center sticky top-0 z-50 shadow-lg">
        <div class="flex flex-col leading-none">
            <div class="font-black text-[#a5a58d] uppercase italic flex items-center gap-2">
                <img id="navLogo" src="" style="height: 25px; width: 25px; object-fit: contain; border-radius: 4px;"> 
                EKELEC <span class="text-[9px] bg-[#6b705c]/20 px-2 py-1 rounded text-[#a5a58d]">V1.0.0.4</span>
            </div>
            <span id="displayGerant" class="text-[9px] font-black uppercase text-gray-500 mt-1 opacity-70">GÉRANT : </span>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="openModal('modalSettings')" title="Paramètres" class="text-gray-400 hover:text-[#a5a58d] text-xl transition">
                <i class="fa-solid fa-gear"></i>
            </button>
            <input type="file" id="importFile" onchange="importData()" class="hidden">
            <button onclick="location.reload()" class="text-red-500 text-xl"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div class="p-4 max-w-6xl mx-auto">
        <div id="viewAccueil">
    <div class="sticky-header">
        <div class="flex justify-between items-end mb-4">
            <h2 class="text-[10px] font-black uppercase tracking-[3px] text-gray-500">Tableau de bord</h2>
            <button onclick="printGlobalReport()" class="bg-neutral-800 hover:bg-neutral-700 px-4 py-2 rounded-lg text-[10px] font-black uppercase flex items-center gap-2 border border-neutral-700">
                <i class="fa-solid fa-print"></i> Bilan Global
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-6">
            <div class="glass p-4 border-b-4 border-gray-500"><p class="text-[9px] uppercase font-black text-gray-500">Projets Actifs</p><p id="statTotalChantiers" class="text-2xl font-black text-white">0</p></div>
            <div class="glass p-4 border-b-4 border-emerald-600"><p class="text-[9px] uppercase font-black text-gray-500">Total Reçu</p><p id="statTotalRecu" class="text-xl font-black text-emerald-500">0 GNF</p></div>
            <div class="glass p-4 border-b-4 border-red-600"><p class="text-[9px] uppercase font-black text-gray-500">Total Dépensé</p><p id="statTotalDepense" class="text-xl font-black text-red-500">0 GNF</p></div>
            <div class="glass p-4 border-b-4 border-[#6b705c]"><p class="text-[9px] uppercase font-black text-gray-500">Solde Comptes</p><p id="statTotalSoldeComptes" class="text-xl font-black text-[#a5a58d]">0 GNF</p></div>
        </div>

        <div class="flex flex-wrap justify-between items-center gap-4 bg-black/80 backdrop-blur-md p-2 rounded-xl border border-white/5">
            <input type="text" id="searchHome" oninput="renderHome()" placeholder="Rechercher un projet..." class="max-w-xs mb-0" autocomplete="off">
            <div class="flex gap-2">
                <button onclick="openFinances()" class="bg-neutral-700 text-white px-4 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg flex items-center gap-2 transition hover:bg-neutral-600"><i class="fa-solid fa-wallet"></i></button>
                <button onclick="openModal('modalTransfert')" class="bg-neutral-800 text-white px-4 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg flex items-center gap-2 transition hover:bg-neutral-700 border border-neutral-600"><i class="fa-solid fa-exchange-alt"></i></button>
                <button onclick="viderChantier(); openModal('modalChantier')" class="bg-[#6b705c] text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-[#a5a58d]">+ Nouveau Projet</button>
            </div>
        </div>
    </div>

    <div id="listeChantiers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"></div>
    
    <div class="mt-12 pt-8 border-t border-neutral-800">
        <div class="flex justify-between items-center">
            <button onclick="toggleArchives()" class="text-gray-500 hover:text-[#a5a58d] text-[10px] font-black uppercase flex items-center gap-2">
                <i id="archiveIcon" class="fa-solid fa-box-archive"></i> <span id="archiveText">Afficher les archives</span>
            </button>
            <button id="btnClearArchives" onclick="clearArchives()" class="hidden text-red-500 hover:text-red-400 text-[10px] font-black uppercase flex items-center gap-2">
                <i class="fa-solid fa-trash-can"></i> Supprimer les archives
            </button>
        </div>
        <div id="listeArchives" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 opacity-60"></div>
    </div>
</div>

       <div id="viewProjet" class="hidden">
    <div class="sticky-projet-header" style="position: sticky; top: 60px; z-index: 100; background: #0a0a0a; padding-bottom: 15px;">
        <button onclick="goHome()" class="text-gray-500 mb-2 text-[9px] font-black uppercase flex items-center gap-2 hover:text-white transition">
            <i class="fa-solid fa-chevron-left"></i> Retour au tableau de bord
        </button>

        <div class="glass p-6 border-l-[12px] border-[#6b705c] shadow-2xl relative">
            <h1 id="chantierTitre" class="text-2xl font-black text-[#a5a58d] uppercase italic leading-none mb-1"></h1>
            <p id="chantierInfos" class="text-[10px] opacity-60 font-bold uppercase mb-4"></p>
            
            <div class="flex flex-wrap gap-3">
                <button onclick="openSaisie()" class="bg-emerald-700 hover:bg-emerald-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg border border-emerald-500/20">
                    <i class="fa-solid fa-plus mr-2"></i>Nouvelle Saisie
                </button>
                <button onclick="printReport()" class="bg-neutral-800 hover:bg-neutral-700 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg border border-neutral-700">
                    <i class="fa-solid fa-print mr-2"></i>Imprimer Rapport
                </button>
            </div>

            <div class="absolute right-6 top-6 text-right">
                <p class="text-[9px] uppercase font-black opacity-30">Solde Caisse</p>
                <p id="soldeChantier" class="text-3xl font-black text-emerald-500">0 GNF</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-4">
 
                <div class="lg:col-span-1 space-y-6">
                    <div class="glass p-5">
                        <h3 class="text-[11px] font-black text-[#a5a58d] uppercase mb-5">Suivi Personnel</h3>
                        <div id="listeOuvriers" class="space-y-4"></div>
                    </div>
					
                    <div class="glass p-5">
                        <h3 class="text-[11px] font-black text-gray-400 uppercase mb-5">Bilans Catégories</h3>
                        <div id="bilanCategories" class="space-y-2 text-[10px] font-bold uppercase"></div>
                    </div>
                    <div class="glass p-5">
                        <h3 class="text-[11px] font-black text-emerald-600 uppercase mb-5">Inventaire Matériel</h3>
                        <div id="inventaireMateriel" class="space-y-2 text-[10px] font-bold uppercase"></div>
                    </div>
                </div>
                <div class="lg:col-span-3 glass overflow-hidden">
                    <div class="overflow-x-auto"> 
                        <table class="w-full text-left text-[11px]">
                            <thead class="bg-neutral-900 text-gray-500 font-black uppercase">
                                <tr><th class="p-5">Opération</th><th class="p-5">Compte</th><th class="p-5">Entrée</th><th class="p-5">Sortie</th><th class="p-5">Solde</th><th class="p-5 text-center">Gestion</th></tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-neutral-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalSettings" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[150] backdrop-blur-md">
    <div class="glass p-8 w-full max-w-md border-t-[10px] border-neutral-600 shadow-2xl overflow-y-auto max-h-[95vh]">
        <h3 class="font-black mb-6 uppercase text-white italic text-xl flex items-center gap-2">
            <i class="fa-solid fa-gear text-[#a5a58d]"></i> Paramètres
        </h3>
        <div class="flex justify-center gap-4 mb-8 bg-black/50 p-4 rounded-xl border border-neutral-800">
            <div class="text-center">
                <img id="logoPreview" src="https://via.placeholder.com/120?text=LOGO" alt="Logo">
                <label class="cursor-pointer bg-[#6b705c] text-white text-[9px] px-3 py-2 rounded font-black uppercase">
                    Modifier Logo <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="previewImage(this, 'logo')">
                </label>
            </div>
            <div class="text-center">
                <img id="signPreview" src="https://via.placeholder.com/120?text=CACHET" alt="Cachet">
                <label class="cursor-pointer bg-[#6b705c] text-white text-[9px] px-3 py-2 rounded font-black uppercase">
                    Modifier Cachet <input type="file" id="signInput" class="hidden" accept="image/*" onchange="previewImage(this, 'sign')">
                </label>
            </div>
        </div>
        <div class="space-y-4">
            <button onclick="openModal('modalCode'); closeModal('modalSettings')" class="w-full flex items-center justify-between bg-neutral-900 p-4 rounded-xl hover:bg-neutral-800 transition">
                <span class="text-[10px] font-black uppercase">Changer le Code d'accès</span>
                <i class="fa-solid fa-key text-[#a5a58d]"></i>
            </button>
            <button onclick="copyDataText()" class="w-full flex items-center justify-between bg-neutral-900 p-4 rounded-xl hover:bg-neutral-800 transition">
                <span class="text-[10px] font-black uppercase">Copier les données (Secours)</span>
                <i class="fa-solid fa-copy text-emerald-500"></i>
            </button>
            <button onclick="exportData()" class="w-full flex items-center justify-between bg-neutral-900 p-4 rounded-xl hover:bg-neutral-800 transition">
                <span class="text-[10px] font-black uppercase">Exporter le fichier (Sauvegarde)</span>
                <i class="fa-solid fa-cloud-arrow-down text-blue-500"></i>
            </button>
            <button onclick="document.getElementById('importFile').click(); closeModal('modalSettings')" class="w-full flex items-center justify-between bg-neutral-900 p-4 rounded-xl hover:bg-neutral-800 transition">
                <span class="text-[10px] font-black uppercase">Importer un fichier</span>
                <i class="fa-solid fa-upload text-yellow-500"></i>
            </button>
            <button onclick="reinitialiserTout()" class="w-full flex items-center justify-between bg-red-900/30 p-4 rounded-xl border border-red-600/50 hover:bg-red-600/50 transition mt-6">
    <span class="text-[10px] font-black uppercase text-red-500">Réinitialiser l'application (Effacer tout)</span>
    <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
</button>
        </div>
        <button onclick="closeModal('modalSettings')" class="w-full mt-6 text-[10px] opacity-40 uppercase font-black hover:opacity-100">Fermer</button>
    </div>
</div>

<div id="modalCode" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[200] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-[#6b705c] shadow-2xl">
        <h3 class="font-black mb-6 uppercase text-[#a5a58d] italic text-xl">Changer Code Accès</h3>
        <input type="password" id="newCode" placeholder="NOUVEAU CODE" autocomplete="new-password">
        <button onclick="changeCode()" class="btn-gold w-full mt-4">ENREGISTRER</button>
        <button onclick="closeModal('modalCode')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="modalSaisie" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-[#6b705c] shadow-2xl overflow-y-auto max-h-[90vh]">
        <h3 class="font-black mb-4 uppercase text-[#a5a58d] italic text-xl">Saisie de Flux</h3>
        <input type="hidden" id="editIndex">
        <label class="text-[10px] font-black uppercase text-gray-500">Compte utilisé</label>
        <select id="fCompte" class="font-bold border-[#6b705c]/50 border mb-4">
            <option value="ESPECES">ESPÈCES</option>
            <option value="ORANGE MONEY">ORANGE MONEY</option>
            <option value="MOBILE MONEY">MOBILE MONEY</option>
            <option value="BANQUE">BANQUE</option>
            <option value="PAYCARD">PAYCARD</option>
            <option value="AUTRES">AUTRES</option>
            <option value="COMPTE EX">COMPTE EX</option>
        </select>
        <label class="text-[10px] font-black uppercase text-gray-500">Type de saisie</label>
        <select id="typeSaisie" onchange="toggleForm()" class="font-bold">
            <option value="DIVERS">DIVERS (Caisse)</option>
            <option value="ARTICLE">ARTICLE (Matériaux)</option>
            <option value="OUVRIER">OUVRIER (Main d'œuvre)</option>
            <option value="LOCATION">LOCATION</option>
        </select>
        <label class="text-[10px] font-black uppercase text-gray-500">Corps de métier / Catégorie</label>
        <select id="fCat" class="font-bold">
            <option value="GENERAL">Général / Divers</option>
            <option value="LOCATAIRE">Locataire</option>
            <option value="DEVIS">Devis</option>
			<option value="DEPENSE">Depense</option>
            <option value="PROPRIETAIRE">Propriétaire</option>
			<option value="MANUTENTION">Manutention</option>
            <option value="ELECTRICITE">Électricité</option>
            <option value="PLOMBERIE">Plomberie</option>
            <option value="MACONNERIE">Maçonnerie</option>
            <option value="PEINTURE">Peinture</option>
            <option value="MENUISERIE">Menuiserie</option>
            <option value="FORAGE">Forage</option>
            <option value="CARRELAGE">Carrelage</option>
            <option value="VITRERIE">Vitrerie</option>
            <option value="SOUDURE">Soudure</option>
            <option value="STAFF">Staff</option>
			<option value="FRAIS G">Frais g</option>
			<option value="AUTRES">Autres</option>
        </select>
        <div id="formD"><input type="text" id="fMotif" placeholder="Désignation" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="text" id="fE" placeholder="Reçu" autocomplete="off"><input type="text" id="fS" placeholder="Payé" autocomplete="off"></div></div>
        <div id="formA" class="hidden"><input type="text" id="fArtNom" placeholder="Nom article" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="text" id="fArtP" placeholder="Prix Unit." autocomplete="off"><input type="text" id="fArtQ" placeholder="Quantité" autocomplete="off"></div></div>
        <div id="formO" class="hidden"><input type="text" id="fOuvNom" oninput="updateOuvrierInfo()" placeholder="Nom ouvrier" autocomplete="off"><input type="text" id="fOuvJob" placeholder="Métier (Ex: Électricien)" autocomplete="off"><input type="text" id="fOuvC" oninput="updateOuvrierInfo()" placeholder="Montant Contrat" autocomplete="off"><div id="infoOuvrierReliquat" class="text-[10px] font-black text-red-400 uppercase mb-1 hidden"></div><input type="text" id="fOuvA" placeholder="Paiement" autocomplete="off"></div>
        <div id="formL" class="hidden"><input type="text" id="fLocNom" placeholder="Nom et Prénom" autocomplete="off"><input type="text" id="fLocBat" placeholder="N° de bâtiment" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="text" id="fLocRecu" placeholder="Reçu (Montant)" autocomplete="off"><input type="text" id="fLocPaye" placeholder="Payé (Sortie)" autocomplete="off"></div><input type="text" id="fLocMois" placeholder="Le(s) mois payé(s)" autocomplete="off"></div>
        <input type="date" id="fDate">
        <div class="grid grid-cols-2 gap-3 mt-6"><button onclick="saveEntry(true)" class="bg-emerald-700 text-white font-black rounded-lg text-[10px] uppercase p-4">Suivant</button><button onclick="saveEntry(false)" class="btn-gold">VALIDER</button></div>
        <button onclick="closeModal('modalSaisie')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="modalChantier" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-[#6b705c] shadow-2xl">
        <h3 id="chantierModalTitre" class="font-black mb-6 uppercase text-[#a5a58d] italic text-xl">Nouveau Projet</h3>
        <input type="hidden" id="editChantierIndex"><input type="text" id="cNom" placeholder="NOM DU CHANTIER" autocomplete="off"><input type="text" id="cLieu" placeholder="LOCALISATION" autocomplete="off"><input type="text" id="cClient" placeholder="NOM DU CLIENT" autocomplete="off">
        <button id="btnCreateChantier" onclick="createChantier()" class="btn-gold shadow-2xl w-full mt-4">CRÉER</button>
        <button onclick="closeModal('modalChantier')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="modalFinances" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass w-full max-w-2xl border-t-[10px] border-[#6b705c] shadow-2xl flex flex-col max-h-[90vh]">
        
        <div class="p-8 pb-4">
            <h3 class="font-black mb-4 uppercase text-[#a5a58d] italic text-xl flex justify-between items-center">
                <span>Opérations Financières</span>
                <div class="flex items-center gap-4">
                    <span id="soldeGlobalFinances" class="text-2xl font-black text-white">0 GNF</span>
                    <button onclick="closeModal('modalFinances')" class="text-gray-500 hover:text-white text-3xl font-light">&times;</button>
                </div>
            </h3>

            <div id="gridComptes" class="grid grid-cols-4 md:grid-cols-4 gap-2 mb-6"></div>

            <div class="bg-black/50 p-6 rounded-xl border border-neutral-800">
                <input type="hidden" id="editOpIndex">
                <div class="grid grid-cols-2 gap-2">
                    <select id="opType" class="font-bold"><option value="DEPOT">DÉPÔT (+)</option><option value="RETRAIT">RETRAIT (-)</option></select>
                    <select id="opCompte" class="font-bold">
                        <option value="ESPECES">ESPÈCES</option>
                        <option value="ORANGE MONEY">ORANGE MONEY</option>
                        <option value="MOBILE MONEY">MOBILE MONEY</option>
                        <option value="BANQUE">BANQUE</option>
                        <option value="PAYCARD">PAYCARD</option>
                        <option value="AUTRES">AUTRES</option>
                        <option value="COMPTE EX">COMPTE EX</option>
                    </select>
                </div>
                <input type="text" id="opMotif" placeholder="Motif de l'opération" autocomplete="off">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="opMontant" placeholder="Montant">
                    <input type="date" id="opDate">
                </div>
                <button onclick="saveOperationFinanciere()" class="btn-gold w-full mt-2">ENREGISTRER L'OPÉRATION</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-8 pb-4">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-neutral-900 uppercase font-black sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Compte</th>
                            <th class="p-3">Motif</th>
                            <th class="p-3">Montant</th>
                            <th class="p-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableOpsBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="px-8 py-4 border-t border-white/5">
            <button onclick="closeModal('modalFinances')" class="w-full text-[10px] opacity-40 uppercase font-black hover:opacity-100 transition">Fermer la fenêtre</button>
        </div>
    </div>
</div>

<div id="modalTransfert" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[110] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-neutral-600 shadow-2xl">
        <h3 class="font-black mb-6 uppercase text-white italic text-xl">Transfert Inter-Projets</h3>
        <label class="text-[10px] font-black uppercase text-gray-500">Projet Source (Départ)</label>
        <select id="tSource" class="font-bold border-neutral-700"></select>
<div id="transfertSoldeInfo" class="text-[10px] font-black text-emerald-500 uppercase mb-4 hidden">Solde disponible : 0 GNF</div>
        <label class="text-[10px] font-black uppercase text-gray-500">Projet Destination (Arrivée)</label>
        <select id="tDest" class="font-bold border-neutral-700"></select>
        <label class="text-[10px] font-black uppercase text-gray-500">Compte utilisé</label>
        <select id="tCompte" class="font-bold">
            <option value="ESPECES">ESPÈCES</option>
            <option value="ORANGE MONEY">ORANGE MONEY</option>
            <option value="MOBILE MONEY">MOBILE MONEY</option>
            <option value="BANQUE">BANQUE</option>
            <option value="PAYCARD">PAYCARD</option>
            <option value="AUTRES">AUTRES</option>
            <option value="COMPTE EX">COMPTE EX</option>
        </select>
        <input type="text" id="tMontant" placeholder="MONTANT DU TRANSFERT">
        <input type="date" id="tDate">
        <button onclick="executerTransfert()" class="btn-gold w-full mt-4">VALIDER LE TRANSFERT</button>
        <button onclick="closeModal('modalTransfert')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="printArea"><div id="printContent"></div></div>

<script>
let currentLogo = localStorage.getItem('EKELEC_LOGO') || "https://via.placeholder.com/120?text=LOGO";
let currentSign = localStorage.getItem('EKELEC_SIGN') || "https://via.placeholder.com/120?text=CACHET";

// On récupère les données existantes ou on crée un tableau vide
let db = JSON.parse(localStorage.getItem('PRO_DB_V9')) || [];let config = JSON.parse(localStorage.getItem('PRO_CONFIG')) || { code: "1234" };
let financeDB = JSON.parse(localStorage.getItem('PRO_FINANCE_V1')) || [];
let currentId = null;

function executePrint() {
    if (window.Android && window.Android.print) {
        // Mode APK : utilise le système Android
        let content = document.getElementById('printArea').innerHTML;
        window.Android.print(content);
    } else {
        // Mode Ordinateur : utilise le navigateur
        window.print();
    }
}

window.onload = () => {
    document.getElementById('loginLogo').src = currentLogo;
    document.getElementById('navLogo').src = currentLogo;
    document.getElementById('logoPreview').src = currentLogo;
    document.getElementById('signPreview').src = currentSign;
    const dernierGerant = localStorage.getItem('DERNIER_GERANT');
    if (dernierGerant) {
        document.getElementById('userGerant').value = dernierGerant;
        document.getElementById('displayGerant').innerText = "GÉRANT : " + dernierGerant.toUpperCase();
    }
};

function previewImage(input, type) {
    if (input.files && input.files[0]) {
        let reader = new FileReader();
        reader.onload = function(e) {
            if(type === 'logo') {
                currentLogo = e.target.result;
                document.getElementById('logoPreview').src = currentLogo;
                document.getElementById('navLogo').src = currentLogo;
                document.getElementById('loginLogo').src = currentLogo;
                localStorage.setItem('EKELEC_LOGO', currentLogo);
            } else {
                currentSign = e.target.result;
                document.getElementById('signPreview').src = currentSign;
                localStorage.setItem('EKELEC_SIGN', currentSign);
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function saveDB() { 
    localStorage.setItem('PRO_DB_V9', JSON.stringify(db)); 
    localStorage.setItem('PRO_FINANCE_V1', JSON.stringify(financeDB));
}

function openModal(id) { 
    if(id === 'modalTransfert') prepareTransfert();
    document.getElementById(id).classList.remove('hidden'); 
    document.getElementById(id).classList.add('flex'); 
}

function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }

function goHome() { document.getElementById('viewAccueil').classList.remove('hidden'); document.getElementById('viewProjet').classList.add('hidden'); renderHome(); }

function openProject(i) { currentId = i; document.getElementById('viewAccueil').classList.add('hidden'); document.getElementById('viewProjet').classList.remove('hidden'); document.getElementById('chantierTitre').innerText = db[i].nom; document.getElementById('chantierInfos').innerText = `${db[i].lieu || ''} | CLIENT: ${db[i].client || 'N/A'}`; renderJournal(); }

function validerParEntree() { if (!document.getElementById('loginPage').classList.contains('hidden')) { checkLogin(); } }

function checkLogin(){
    const gerant = document.getElementById('userGerant').value;
    const pass = document.getElementById('passAccess').value;
    if(pass === config.code && gerant.trim() !== "") {
        localStorage.setItem('DERNIER_GERANT', gerant);
        document.getElementById('displayGerant').innerText = "GÉRANT : " + gerant.toUpperCase();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderHome();
    } else { alert("CODE INCORRECT"); document.getElementById('passAccess').value = ""; }
}

function changeCode() {
    const n = document.getElementById('newCode').value;
    if(n.length >= 4) { config.code = n; localStorage.setItem('PRO_CONFIG', JSON.stringify(config)); alert("CODE MODIFIÉ"); closeModal('modalCode'); } else { alert("MINIMUM 4 CHIFFRES"); }
}

function toggleForm() {
    const t = document.getElementById('typeSaisie').value;
    document.getElementById('formD').classList.toggle('hidden', t !== 'DIVERS');
    document.getElementById('formA').classList.toggle('hidden', t !== 'ARTICLE');
    document.getElementById('formO').classList.toggle('hidden', t !== 'OUVRIER');
    document.getElementById('formL').classList.toggle('hidden', t !== 'LOCATION');
    document.getElementById('infoOuvrierReliquat').classList.add('hidden');
}

function openSaisie() { viderSaisie(); document.getElementById('fDate').valueAsDate = new Date(); openModal('modalSaisie'); }

function updateOuvrierInfo() {
    const nom = document.getElementById('fOuvNom').value.trim().toUpperCase();
    const infoDiv = document.getElementById('infoOuvrierReliquat');
    if(!nom || currentId === null) { infoDiv.classList.add('hidden'); return; }
    let payeTotal = 0, contrat = parseNum(document.getElementById('fOuvC').value);
    db[currentId].flux.forEach(f => {
        if(f.type === 'OUVRIER' && f.on.toUpperCase() === nom) {
            payeTotal += f.s;
            if(contrat === 0) contrat = f.oc;
        }
    });
    if(payeTotal > 0 || contrat > 0) {
        infoDiv.innerText = `Reste à payer : ${(contrat - payeTotal).toLocaleString()} GNF`;
        infoDiv.classList.remove('hidden');
    } else { infoDiv.classList.add('hidden'); }
}

function renderHome(){
    const div = document.getElementById('listeChantiers');
    const divArch = document.getElementById('listeArchives');
    const search = document.getElementById('searchHome').value.toLowerCase();
    div.innerHTML = ""; divArch.innerHTML = ""; 
    let gRecu = 0, gDepense = 0, activeCount = 0;
    db.forEach((c,i)=>{
        let inT=0, outT=0; c.flux.forEach(f=>{ inT+=f.e; outT+=f.s; });
        let soldeP = inT - outT;
        let pct = 0;
        if(inT > 0) pct = Math.min((outT / inT) * 100, 100);
        let barColor = pct > 90 ? 'bg-red-500' : 'bg-emerald-600';
        let alertClass = pct > 90 ? 'alert-pulse' : '';
        if(!c.archive) { gRecu += inT; gDepense += outT; activeCount++; }
        if(c.nom.toLowerCase().includes(search)){
            let html = `<div class="glass p-6 relative cursor-pointer border-b-4 border-transparent hover:border-[#6b705c]" onclick="openProject(${i})">
                <h3 class="text-xl font-black text-[#a5a58d] uppercase italic">${c.nom}</h3>
                <div class="w-full bg-neutral-800 h-1.5 rounded-full mt-2 mb-4 overflow-hidden">
                    <div class="${barColor} ${alertClass} h-full transition-all duration-500" style="width: ${pct}%"></div>
                </div>
                <div class="mt-4 space-y-1">
                    <div class="flex justify-between text-[10px] font-black"><span>REÇU:</span><span class="text-emerald-500">${inT.toLocaleString()} GNF</span></div>
                    <div class="flex justify-between text-[10px] font-black"><span>SORTIE:</span><span class="text-red-500">${outT.toLocaleString()} GNF</span></div>
                    <div class="flex justify-between text-[10px] font-black pt-1 border-t border-neutral-800"><span>SOLDE:</span><span class="text-[#a5a58d]">${soldeP.toLocaleString()} GNF</span></div>
                </div>
                <div class="absolute top-4 right-4 flex gap-3">
                    ${c.archive ? `<button onclick="restoreProject(event, ${i})" title="Restaurer" class="text-emerald-500"><i class="fa-solid fa-rotate-left"></i></button>` : `<button onclick="archiveProject(event, ${i})" title="Archiver" class="text-gray-500 hover:text-[#a5a58d]"><i class="fa-solid fa-box-archive"></i></button>`}
                    <button onclick="editProject(event, ${i})" class="text-blue-500 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteProject(event, ${i})" class="text-neutral-700 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
            if(c.archive) divArch.innerHTML += html; else div.innerHTML += html;
        }
    });
    let totalComptes = 0;
    ["ORANGE MONEY", "MOBILE MONEY", "BANQUE", "PAYCARD", "COMPTE EX", "ESPECES", "AUTRES"].forEach(nom => { totalComptes += getSoldeCompte(nom); });
    document.getElementById('statTotalChantiers').innerText = activeCount;
    document.getElementById('statTotalRecu').innerText = gRecu.toLocaleString() + " GNF";
    document.getElementById('statTotalDepense').innerText = gDepense.toLocaleString() + " GNF";
    document.getElementById('statTotalSoldeComptes').innerText = totalComptes.toLocaleString() + " GNF";
    document.getElementById('statTotalSoldeComptes').className = totalComptes < 0 ? "text-xl font-black text-red-500" : "text-xl font-black text-[#a5a58d]";
}

function openFinances() { viderFormOp(); document.getElementById('opDate').valueAsDate = new Date(); renderFinances(); openModal('modalFinances'); }

function getSoldeCompte(nomCompte) {
    let solde = 0;
    db.forEach(c => { c.flux.forEach(f => { if(f.compte === nomCompte) solde += (parseNum(f.e) - parseNum(f.s)); }); });
    financeDB.forEach(op => { if(op.compte === nomCompte) solde += (op.type === 'DEPOT' ? parseNum(op.montant) : -parseNum(op.montant)); });
    return solde;
}

function renderFinances() {
    const grid = document.getElementById('gridComptes');
    const table = document.getElementById('tableOpsBody');
    grid.innerHTML = ""; table.innerHTML = "";
    const comptes = ["ORANGE MONEY", "MOBILE MONEY", "BANQUE", "PAYCARD", "COMPTE EX", "ESPECES", "AUTRES"];
    let totalGlobal = 0;
    comptes.forEach(nom => {
        const s = getSoldeCompte(nom);
        totalGlobal += s;
        grid.innerHTML += `<div class="glass p-3 bg-neutral-900 border-l-4 ${s < 0 ? 'border-red-600' : 'border-emerald-600'}">
            <p class="text-[8px] font-black uppercase opacity-50">${nom}</p>
            <p class="text-[11px] font-black ${s < 0 ? 'text-red-400' : 'text-white'}">${s.toLocaleString()} GNF</p>
        </div>`;
    });
    document.getElementById('soldeGlobalFinances').innerText = totalGlobal.toLocaleString() + " GNF";
    document.getElementById('soldeGlobalFinances').className = totalGlobal < 0 ? "text-2xl font-black text-red-500" : "text-2xl font-black text-white";
    financeDB.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((op, idx) => {
        table.innerHTML += `<tr class="border-b border-neutral-800">
            <td class="p-3"><span class="font-black uppercase block">${op.compte}</span><span class="opacity-40 text-[8px]">${op.date}</span></td>
            <td class="p-3 opacity-70">${op.motif}</td>
            <td class="p-3 font-black ${op.type === 'DEPOT' ? 'text-emerald-500' : 'text-red-400'}">${op.type === 'DEPOT' ? '+' : '-'}${op.montant.toLocaleString()}</td>
            <td class="p-3 text-right">
                <button onclick="editOperation(${idx})" class="text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button>
                <button onclick="deleteOperation(${idx})" class="text-neutral-600"><i class="fa-solid fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function saveOperationFinanciere() {
    const idx = document.getElementById('editOpIndex').value;
    const op = {
        type: document.getElementById('opType').value,
        compte: document.getElementById('opCompte').value,
        motif: document.getElementById('opMotif').value || "Mouvement direct",
        montant: parseNum(document.getElementById('opMontant').value),
        date: document.getElementById('opDate').value
    };
    if(op.montant <= 0) return alert("Montant invalide");
    if(idx !== "") financeDB[idx] = op; else financeDB.push(op);
    saveDB(); renderFinances(); renderHome(); viderFormOp();
}

function editOperation(idx) {
    const op = financeDB[idx];
    document.getElementById('editOpIndex').value = idx;
    document.getElementById('opType').value = op.type;
    document.getElementById('opCompte').value = op.compte;
    document.getElementById('opMotif').value = op.motif;
    document.getElementById('opMontant').value = op.montant;
    document.getElementById('opDate').value = op.date;
}

function deleteOperation(idx) { if(confirm("Supprimer cette opération ?")) { financeDB.splice(idx, 1); saveDB(); renderFinances(); renderHome(); } }
function viderFormOp() { document.getElementById('editOpIndex').value = ""; document.getElementById('opMotif').value = ""; document.getElementById('opMontant').value = ""; document.getElementById('opDate').valueAsDate = new Date(); }

function renderJournal(){
    const c = db[currentId];
    const tbody = document.getElementById('tableBody'); 
    const lOuv = document.getElementById('listeOuvriers');
    const divBilan = document.getElementById('bilanCategories');
    const divInv = document.getElementById('inventaireMateriel');
    tbody.innerHTML = ""; lOuv.innerHTML = ""; divBilan.innerHTML = ""; divInv.innerHTML = "";
    let workers = {}; let cats = {};
    let runningSolde = 0; let items = {};
    c.flux.sort((a, b) => new Date(a.date) - new Date(b.date));
    c.flux.forEach((f,idx)=>{
        runningSolde += (f.e - f.s);
        let ct = f.cat || 'GENERAL';
        if(!cats[ct]) cats[ct] = 0;
        cats[ct] += f.s;
        if(f.type==='ARTICLE'){
            let name = f.txt.replace("ARTICLE : ", "").split(" (x")[0];
            let qMatch = f.txt.match(/\(x(\d+)\)/);
            let q = qMatch ? parseInt(qMatch[1]) : 1;
            items[name] = (items[name] || 0) + q;
        }
        if(f.type==='OUVRIER'){
            if(!workers[f.on]) workers[f.on]={job:f.oj, contrat:f.oc, paye:0};
            workers[f.on].paye += f.s;
        }
        tbody.innerHTML += `<tr>
            <td class="p-5 font-bold uppercase">${f.txt}<br><span class="opacity-30 text-[9px] mr-2">${f.date}</span> <span class="text-[8px] font-black bg-neutral-800 px-2 py-0.5 rounded text-[#a5a58d]">${f.cat || 'GENERAL'}</span></td>
            <td class="p-5 font-black opacity-60 text-[10px] uppercase">${f.compte || 'ESPECES'}</td>
            <td class="p-5 text-emerald-500 font-black">${f.e>0?f.e.toLocaleString():'-'}</td>
            <td class="p-5 text-red-500 font-black">${f.s>0?f.s.toLocaleString():'-'}</td>
            <td class="p-5 font-black text-white">${runningSolde.toLocaleString()}</td>
            <td class="p-5 text-center flex gap-4 justify-center">
                <button onclick="editEntry(${idx})" class="text-blue-500"><i class="fa-solid fa-pen"></i></button>
                <button onclick="deleteEntry(${idx})" class="text-neutral-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
            </td>
        </tr>`;
    });
    for(let k in cats) { if(cats[k] > 0) divBilan.innerHTML += `<div class="flex justify-between border-b border-neutral-800 pb-1"><span>${k}</span><span class="text-gray-400">${cats[k].toLocaleString()} GNF</span></div>`; }
    for(let it in items) { divInv.innerHTML += `<div class="flex justify-between border-b border-neutral-800 pb-1"><span>${it}</span><span class="text-emerald-500">x ${items[it]}</span></div>`; }
    document.getElementById('soldeChantier').innerText = runningSolde.toLocaleString() + " GNF";
    for(let n in workers){
        let r = workers[n].contrat - workers[n].paye;
        lOuv.innerHTML += `<div class="bg-black/50 p-4 rounded-xl border-l-4 border-[#6b705c]">
            <div class="flex justify-between mb-2">
                <div class="flex items-center gap-2"><button onclick="ajouterAcompteRapide('${n.replace(/'/g, "\\'")}', '${workers[n].job.replace(/'/g, "\\'")}', ${workers[n].contrat})" class="text-emerald-500 hover:scale-125 transition" title="Ajouter un acompte"><i class="fa-solid fa-circle-plus"></i></button><span class="font-black text-[10px] uppercase">${n}</span></div>
                <div class="flex gap-2"><button onclick="printRecu('${n.replace(/'/g, "\\'")}')" class="text-white opacity-40 hover:opacity-100 text-xs"><i class="fa-solid fa-print"></i></button></div>
            </div>
            <div class="flex justify-between items-end"><span class="text-[9px] opacity-30">RESTE</span><span class="font-black text-xs ${r<=0?'text-emerald-500':'text-red-500'}">${r.toLocaleString()} GNF</span></div></div>`;
    }
}

function ajouterAcompteRapide(nom, job, contrat) { viderSaisie(); document.getElementById('typeSaisie').value = "OUVRIER"; toggleForm(); document.getElementById('fOuvNom').value = nom; document.getElementById('fOuvJob').value = job; document.getElementById('fOuvC').value = contrat; document.getElementById('fDate').valueAsDate = new Date(); updateOuvrierInfo(); openModal('modalSaisie'); }

function parseNum(v) { if(!v) return 0; return parseFloat(String(v).replace(',', '.')) || 0; }

function editEntry(idx) {
    const f = db[currentId].flux[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('typeSaisie').value = f.type;
    document.getElementById('fCompte').value = f.compte || "ESPECES";
    toggleForm();
    document.getElementById('fDate').value = f.date;
    document.getElementById('fCat').value = f.cat || "GENERAL";
    if(f.type === 'DIVERS') { document.getElementById('fE').value = f.e; document.getElementById('fS').value = f.s; document.getElementById('fMotif').value = f.txt; }
    else if(f.type === 'ARTICLE') { 
        document.getElementById('fArtNom').value = f.txt.replace("ARTICLE : ", "").split(" (x")[0];
        let qMatch = f.txt.match(/\(x(\d+)\)/); let q = qMatch ? parseInt(qMatch[1]) : 1;
        document.getElementById('fArtP').value = f.s / q; document.getElementById('fArtP').placeholder = ""; document.getElementById('fArtQ').value = q;
    }
    else if(f.type === 'OUVRIER') { document.getElementById('fOuvNom').value = f.on; document.getElementById('fOuvJob').value = f.oj; document.getElementById('fOuvC').value = f.oc; document.getElementById('fOuvA').value = f.s; updateOuvrierInfo(); }
    else if(f.type === 'LOCATION') { document.getElementById('fLocNom').value = f.txt.split(' : ')[1].split(' (BAT')[0]; document.getElementById('fLocBat').value = f.locBat; document.getElementById('fLocMois').value = f.locMois; document.getElementById('fLocRecu').value = f.e; document.getElementById('fLocPaye').value = f.s; }
    openModal('modalSaisie');
}

function saveEntry(keepOpen) {
    const idx = document.getElementById('editIndex').value;
    const type = document.getElementById('typeSaisie').value;
    let entry = { type: type, date: document.getElementById('fDate').value, cat: document.getElementById('fCat').value, compte: document.getElementById('fCompte').value, e: 0, s: 0, txt: "", oc: 0, on: "", oj: "", locBat: "", locMois: "" };
    if(type === 'DIVERS') { entry.e = parseNum(document.getElementById('fE').value); entry.s = parseNum(document.getElementById('fS').value); entry.txt = document.getElementById('fMotif').value || "Divers"; }
    else if(type === 'ARTICLE') { let p = parseNum(document.getElementById('fArtP').value), q = parseNum(document.getElementById('fArtQ').value); let nomArt = document.getElementById('fArtNom').value; entry.s = p * q; entry.txt = `ARTICLE : ${nomArt.toUpperCase()} (x${q})`; }
    else if(type === 'OUVRIER') { entry.on = document.getElementById('fOuvNom').value.trim(); entry.oj = document.getElementById('fOuvJob').value; entry.oc = parseNum(document.getElementById('fOuvC').value); entry.s = parseNum(document.getElementById('fOuvA').value); entry.txt = `PAYE : ${entry.on.toUpperCase()}`; }
    else if(type === 'LOCATION') { const nom = document.getElementById('fLocNom').value.toUpperCase(); const bat = document.getElementById('fLocBat').value; const mois = document.getElementById('fLocMois').value; entry.e = parseNum(document.getElementById('fLocRecu').value); entry.s = parseNum(document.getElementById('fLocPaye').value); entry.locBat = bat; entry.locMois = mois; entry.txt = `LOCATION : ${nom} (BAT: ${bat}) - MOIS: ${mois}`; }
    if(idx !== "") db[currentId].flux[idx] = entry; else db[currentId].flux.push(entry);
    saveDB(); renderJournal(); renderHome(); viderSaisie(); if(!keepOpen) closeModal('modalSaisie');
}

function viderSaisie() { document.querySelectorAll('#modalSaisie input').forEach(i => i.value = ""); document.getElementById('editIndex').value = ""; document.getElementById('fCat').value = "GENERAL"; document.getElementById('typeSaisie').value = "DIVERS"; document.getElementById('fCompte').value = "ESPECES"; toggleForm(); }

function deleteEntry(idx) { if(confirm("Supprimer cette ligne ?")) { db[currentId].flux.splice(idx, 1); saveDB(); renderJournal(); renderHome(); } }

function viderChantier() { document.getElementById('cNom').value = ""; document.getElementById('cLieu').value = ""; document.getElementById('cClient').value = ""; document.getElementById('editChantierIndex').value = ""; document.getElementById('chantierModalTitre').innerText = "Nouveau Projet"; document.getElementById('btnCreateChantier').innerText = "CRÉER"; }

function editProject(e, i) { e.stopPropagation(); const c = db[i]; document.getElementById('editChantierIndex').value = i; document.getElementById('cNom').value = c.nom; document.getElementById('cLieu').value = c.lieu; document.getElementById('cClient').value = c.client; document.getElementById('chantierModalTitre').innerText = "Modifier Projet"; document.getElementById('btnCreateChantier').innerText = "METTRE À JOUR"; openModal('modalChantier'); }

function createChantier() { const n = document.getElementById('cNom').value.trim(); const idx = document.getElementById('editChantierIndex').value; if(n) { if(idx !== "") { db[idx].nom = n; db[idx].lieu = document.getElementById('cLieu').value; db[idx].client = document.getElementById('cClient').value; } else { db.push({ nom: n, lieu: document.getElementById('cLieu').value, client: document.getElementById('cClient').value, flux: [], archive: false }); } saveDB(); viderChantier(); closeModal('modalChantier'); renderHome(); } }

function deleteProject(e, i) { 
    e.stopPropagation(); 
    const codeCheck = prompt("SÉCURITÉ : Entrez le CODE ACCÈS pour supprimer ce projet :"); 
    if(codeCheck === config.code) { 
        if(confirm("Confirmer la suppression ? La trace financière sera conservée dans l'historique global.")) { 
            const c = db[i];
            // On extrait les totaux pour garder la trace en caisse
            let inT = 0, outT = 0;
            c.flux.forEach(f => { inT += f.e; outT += f.s; });

            // On injecte ces mouvements dans la finance globale avant de supprimer
            if(inT > 0 || outT > 0) {
                financeDB.push({
                    type: 'DEPOT',
                    compte: 'ESPECES',
                    motif: `ARCHIVE FLUX (ENTRÉE) : ${c.nom.toUpperCase()}`,
                    montant: inT,
                    date: new Date().toISOString().split('T')[0]
                });
                financeDB.push({
                    type: 'RETRAIT',
                    compte: 'ESPECES',
                    motif: `ARCHIVE FLUX (SORTIE) : ${c.nom.toUpperCase()}`,
                    montant: outT,
                    date: new Date().toISOString().split('T')[0]
                });
            }

            db.splice(i,1); 
            saveDB(); 
            renderHome(); 
            alert("Projet supprimé. Le solde global est préservé.");
        } 
    } 
}

function archiveProject(e, i) { e.stopPropagation(); if(confirm("Archiver ce projet ?")) { db[i].archive = true; saveDB(); renderHome(); } }

function restoreProject(e, i) { e.stopPropagation(); if(confirm("Restaurer ce projet ?")) { db[i].archive = false; saveDB(); renderHome(); } }

function toggleArchives() { 
    const div = document.getElementById('listeArchives'); 
    const text = document.getElementById('archiveText'); 
    const icon = document.getElementById('archiveIcon'); 
    const btnClear = document.getElementById('btnClearArchives');
    if(div.classList.contains('hidden')) { 
        div.classList.remove('hidden'); 
        text.innerText = "Masquer les archives"; 
        icon.classList.replace('fa-box-archive', 'fa-eye-slash');
        btnClear.classList.remove('hidden');
    } else { 
        div.classList.add('hidden'); 
        text.innerText = "Afficher les archives"; 
        icon.classList.replace('fa-eye-slash', 'fa-box-archive'); 
        btnClear.classList.add('hidden');
    } 
}

function prepareTransfert() {
    const sSource = document.getElementById('tSource');
    const sDest = document.getElementById('tDest');
    const infoSolde = document.getElementById('transfertSoldeInfo');
    sSource.innerHTML = '<option value="">-- Choisir Source --</option>';
    sDest.innerHTML = '<option value="">-- Choisir Destination --</option>';
    db.forEach((c, i) => {
        if(!c.archive) {
            let opt = `<option value="${i}">${c.nom.toUpperCase()}</option>`;
            sSource.innerHTML += opt;
            sDest.innerHTML += opt;
        }
    });
    sSource.onchange = () => {
        const idx = sSource.value;
        if(idx !== "") {
            let inT = 0, outT = 0;
            db[idx].flux.forEach(f => { inT += f.e; outT += f.s; });
            const solde = inT - outT;
            infoSolde.innerText = `Solde disponible : ${solde.toLocaleString()} GNF`;
            infoSolde.classList.remove('hidden');
        } else { infoSolde.classList.add('hidden'); }
    };
    infoSolde.classList.add('hidden');
    document.getElementById('tDate').valueAsDate = new Date();
}

function executerTransfert() {
    const idxS = document.getElementById('tSource').value;
    const idxD = document.getElementById('tDest').value;
    const montant = parseNum(document.getElementById('tMontant').value);
    const compteSource = document.getElementById('tCompte').value; // Le compte qui donne
    const compteDest = prompt("VERS QUEL COMPTE ? (ESPECES, BANQUE, ORANGE MONEY...)", compteSource) || compteSource; // Le compte qui reçoit
    const date = document.getElementById('tDate').value;

    if(idxS === "" || idxD === "" || idxS === idxD || montant <= 0) { 
        alert("Veuillez vérifier les projets et le montant."); 
        return; 
    }

    // Sortie du Projet A avec le compte Source
    db[idxS].flux.push({ 
        type: 'DIVERS', date: date, cat: 'TRANSFERT', 
        compte: compteSource.toUpperCase(), 
        e: 0, s: montant, 
        txt: `TRANSFERT VERS : ${db[idxD].nom.toUpperCase()} (${compteDest.toUpperCase()})` 
    });

    // Entrée dans le Projet B avec le compte Destination
    db[idxD].flux.push({ 
        type: 'DIVERS', date: date, cat: 'TRANSFERT', 
        compte: compteDest.toUpperCase(), 
        e: montant, s: 0, 
        txt: `TRANSFERT DEPUIS : ${db[idxS].nom.toUpperCase()} (${compteSource.toUpperCase()})` 
    });

    saveDB(); renderHome(); closeModal('modalTransfert'); 
    alert("Transfert inter-projets et inter-comptes effectué !");
}

function printReport() { 
    const c = db[currentId];
    let ti = 0, to = 0, soldeCaisse = 0; let ouvriersSuivi = {}; 
    const gerant = document.getElementById('userGerant').value.toUpperCase();
    
    // --- CHANGEMENT DU NOM DU FICHIER PDF ---
    const ancienTitre = document.title;
    document.title = "RAPPORT_" + c.nom.toUpperCase();
    // ----------------------------------------

    let h = `<div style="padding:30px; background:#fff; color:#000"><div class="report-header">
    <div class="info-block">
        <h1 class="report-title">RAPPORT D'ACTIVITÉ ${c.archive ? '(ARCHIVÉ)' : ''}</h1>
        <span class="info-line">PROJET : <b>${c.nom.toUpperCase()}</b></span>
        <span class="info-line">LIEU : <b>${c.lieu.toUpperCase() || 'N/A'}</b></span>
        <span class="info-line">CLIENT : <b>${c.client.toUpperCase() || 'N/A'}</b></span>
    </div>
    <div class="info-block" style="text-align:right;">
        <span class="info-line">DATE : <b>${new Date().toLocaleDateString()}</b></span>
        <span class="info-line">GÉRANT : <b>${gerant}</b></span>
    </div>
</div><table><thead><tr><th>DATE</th><th>LIBELLÉ (CATÉGORIE)</th><th>ENTRÉE</th><th>SORTIE</th><th>SOLDE</th></tr></thead><tbody>`; 
    
    c.flux.forEach((f) => { 
        ti += f.e; to += f.s; soldeCaisse += (f.e - f.s); 
        let rowClass = f.e > 0 ? 'row-entree' : (f.s > 0 ? 'row-sortie' : '');
        let sortieTxt = f.s > 0 ? f.s.toLocaleString() : '-'; 
        if(f.type === 'OUVRIER') { 
            if(!ouvriersSuivi[f.on]) ouvriersSuivi[f.on] = 0; 
            ouvriersSuivi[f.on] += f.s; 
            let resteCalcul = (f.oc || 0) - ouvriersSuivi[f.on];
            sortieTxt = `<b>${f.s.toLocaleString()}</b>` + (f.oc > 0 ? ` <span style="font-size:8px">(Reste: ${resteCalcul.toLocaleString()})</span>` : ''); 
        } 
        h += `<tr class="${rowClass}"><td>${f.date}</td><td><b>${f.txt}</b> <span class="cat-badge">${f.cat || 'GENERAL'}</span></td><td style="text-align:right">${f.e>0?f.e.toLocaleString():'-'}</td><td style="text-align:right">${sortieTxt}</td><td style="text-align:right; background:#f8fafc"><b>${soldeCaisse.toLocaleString()}</b></td></tr>`; 
    });

    h += `</tbody></table><div class="total-box total-depense-rouge">TOTAL DÉPENSÉ : ${to.toLocaleString()} GNF</div><div class="total-box">SOLDE NET EN CAISSE : ${(ti-to).toLocaleString()} GNF</div><div class="signature-area"><p style="font-size:10px; margin-bottom:5px;">Cachet & Signature :</p><img src="${currentSign}"></div></div>`;
    
    document.getElementById('printContent').innerHTML = h; 
    
    // On lance l'impression
    executePrint(); 

    // On remet le titre original après l'impression
    setTimeout(() => { document.title = ancienTitre; }, 1000);
}

function printRecu(nomOuvrier) {
    const c = db[currentId];
    let payeTotal = 0, contrat = 0, métier = "", history = "";
    c.flux.forEach(f => { if(f.type === 'OUVRIER' && f.on === nomOuvrier) { payeTotal += f.s; contrat = f.oc; métier = f.oj; history += `<tr><td>${f.date}</td><td>Acompte / Paiement</td><td style="text-align:right">${f.s.toLocaleString()} GNF</td></tr>`; } });
    let h = `<div style="padding:40px; color:#000; background:#fff; font-family:sans-serif;"><div class="report-header"><div><h1 class="report-title">REÇU DE PAIEMENT</h1><p class="recu-ouvrier-title">OUVRIER : <b>${nomOuvrier.toUpperCase()}</b></p></div><div style="text-align:right"><p class="info-line">DATE : ${new Date().toLocaleDateString()}</p></div></div><div style="margin-bottom:20px;"><p class="info-line">PROJET : <b>${c.nom.toUpperCase()}</b></p><p class="info-line">MÉTIER : <b>${métier.toUpperCase()}</b></p><p class="info-line">MONTANT CONTRAT : <b>${contrat.toLocaleString()} GNF</b></p></div><table><thead><tr><th>DATE</th><th>DESCRIPTION</th><th>MONTANT</th></tr></thead><tbody>${history}</tbody></table><div class="total-box">TOTAL PAYÉ : ${payeTotal.toLocaleString()} GNF</div><div class="total-box ${contrat-payeTotal > 0 ? 'total-depense-rouge' : ''}">RESTE À PAYER : ${(contrat-payeTotal).toLocaleString()} GNF</div><div class="signature-area"><img src="${currentSign}"></div></div>`;
    document.getElementById('printContent').innerHTML = h; executePrint();
}

function printGlobalReport() { 
    let gRecu = 0, gDepense = 0;
    const gerant = document.getElementById('userGerant').value.toUpperCase(); 
    let h = `<div style="padding:30px; color:#000; background:#fff"><div class="report-header"><div><h1 class="report-title">BILAN GÉNÉRAL</h1><p class="info-line">GÉRANT : <b>${gerant}</b></p></div><div style="text-align:right"><p class="info-line">DATE : ${new Date().toLocaleDateString()}</p></div></div><table><thead><tr><th>CHANTIER</th><th>CLIENT</th><th style="text-align:right">REÇU</th><th style="text-align:right">DÉPENSÉ</th><th style="text-align:right">SOLDE</th></tr></thead><tbody>`;
    db.forEach(c => { if(!c.archive) { let inT=0, outT=0; c.flux.forEach(f=>{ inT+=f.e; outT+=f.s; }); gRecu += inT; gDepense += outT; h += `<tr><td><b>${c.nom.toUpperCase()}</b></td><td>${c.client.toUpperCase()}</td><td style="text-align:right">${inT.toLocaleString()}</td><td style="text-align:right">${outT.toLocaleString()}</td><td style="text-align:right"><b>${(inT-outT).toLocaleString()}</b></td></tr>`; } });
    h += `</tbody></table><div class="total-box">SOLDE GLOBAL (PROJETS ACTIFS) : ${(gRecu-gDepense).toLocaleString()} GNF</div><div class="signature-area"><img src="${currentSign}"></div></div>`;
    document.getElementById('printContent').innerHTML = h; executePrint();
}

function exportData() {
    const data = JSON.stringify({db, config, logo: currentLogo, sign: currentSign, financeDB});
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
    a.download = `EKELEC_SAVE_${new Date().toISOString().split('T')[0]}.json`; a.click();
}

function copyDataText() {
    const data = JSON.stringify({db, config, logo: currentLogo, sign: currentSign, financeDB});
    navigator.clipboard.writeText(data).then(() => { alert("DONNÉES COPIÉES !"); });
}

function importData() {
    if(!confirm("ATTENTION : Importer va EFFACER vos données actuelles. Confirmer ?")) return;
    const file = document.getElementById('importFile').files[0]; 
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) { 
        try {
            const data = JSON.parse(e.target.result);
            db = data.db; config = data.config; 
            if(data.financeDB) financeDB = data.financeDB;
            if(data.logo) { currentLogo = data.logo; localStorage.setItem('EKELEC_LOGO', currentLogo); }
            if(data.sign) { currentSign = data.sign; localStorage.setItem('EKELEC_SIGN', currentSign); }
            saveDB(); location.reload(); 
        } catch(err) { alert("Erreur lors de la lecture du fichier."); }
    };
    reader.readAsText(file);
}

function clearArchives() {
    const codeCheck = prompt("SÉCURITÉ : Entrez le CODE ACCÈS pour vider les archives :");
    if(codeCheck === config.code) {
        if(confirm("Confirmer la suppression DEFINITIVE de tous les projets archivés ?")) {
            db = db.filter(c => !c.archive);
            saveDB();
            renderHome();
            toggleArchives();
            alert("Archives vidées.");
        }
    } else if (codeCheck !== null) {
        alert("CODE INCORRECT");
    }
}
function reinitialiserTout() {
    const codeCheck = prompt("SÉCURITÉ CRITIQUE : Entrez le CODE ACCÈS pour TOUT EFFACER :");
    if(codeCheck === config.code) {
        if(confirm("ATTENTION : Cette action est irréversible. Voulez-vous vraiment supprimer TOUS les projets et TOUTES les finances ?")) {
            localStorage.clear();
            alert("Application réinitialisée avec succès.");
            location.reload();
        }
    } else if (codeCheck !== null) {
        alert("CODE INCORRECT");
    }
}
function sauvegarderDonnees() {
    localStorage.setItem('PRO_DB_V9', JSON.stringify(db));
}
</script>
</body>
</html>
