<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EKELEC V9.9.9</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
.glass { background: #1e293b; border: 1px solid #334155; border-radius: 20px; transition:0.3s; }
input, select { background: #0f172a !important; border: 1px solid #475569 !important; color: white !important; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; outline: none; }
.btn-gold { background: #f59e0b; color: black; font-weight: bold; text-transform: uppercase; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.3s; border:none; }
.btn-gold:hover { background: #fbbf24; transform: translateY(-2px); }

#logoPreview { max-width: 120px; max-height: 120px; margin: 0 auto 15px; display: block; object-fit: contain; }

@media (max-width: 768px) {
    #viewProjet .glass.p-8 { position: relative; padding: 20px !important; }
    #chantierTitre { font-size: 1.5rem !important; line-height: 1.2 !important; margin-bottom: 10px !important; }
    #viewProjet .absolute.right-8.top-8 { 
        position: static !important; 
        text-align: left !important; 
        margin-top: 15px; 
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    #soldeChantier { font-size: 1.8rem !important; }
}

#printArea { display: none; }
@media print {
    @page { margin: 0.8cm; size: auto; }
    html, body { height: 99%; overflow: hidden; background: white !important; }
    #app, #loginPage, #modalCode { display: none !important; }
    #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; padding: 0; margin: 0; }
    .report-header { border-bottom: 4px solid #f59e0b; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
    .report-title { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #000; margin-bottom: 5px; }
    .recu-ouvrier-title { font-size: 16px !important; border-bottom: 2px solid #000; display: inline-block; margin-bottom: 10px; }
    .info-block { line-height: 1.6; }
    .info-line { font-size: 13px; color: #000 !important; margin-bottom: 4px; display: block; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #f1f5f9 !important; border: 1px solid #000; padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; color: #000 !important; }
    td { border: 1px solid #cbd5e1; padding: 6px; font-size: 10px; color: #000 !important; }
    .total-box { border: 2px solid #000; padding: 8px; margin-top: 4px; text-align: right; font-size: 13px; font-weight: 900; background: #f8fafc !important; color: #000 !important; }
    .total-depense-rouge { color: #dc2626 !important; border-color: #dc2626 !important; }
    .cat-badge { font-size: 8px; text-transform: uppercase; background: #eee; padding: 2px 4px; border-radius: 3px; color: #666; font-weight: bold; }
}
</style>
</head>
<body onkeydown="if(event.key==='Enter') validerParEntree()">

<div id="loginPage" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-950">
    <div class="glass p-10 w-full max-w-md text-center shadow-2xl">
        <img id="logoPreview" src="https://via.placeholder.com/120?text=LOGO" alt="Logo">
        <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-[10px] px-3 py-1 rounded mb-6 inline-block font-black uppercase">
            <i class="fa-solid fa-image mr-1"></i> Changer le logo
            <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="previewImage(this)">
        </label>
        <h1 class="text-4xl font-black text-amber-500 mb-6 italic uppercase tracking-tighter">EKELEC</h1>
        <p class="text-[10px] text-slate-400 uppercase font-black mb-4 tracking-[3px]">Accès Gestionnaire</p>
        <input type="text" id="userGerant" value="EKELEC" class="text-center mb-2 uppercase font-bold border-amber-500/30" autocomplete="off">
        <input type="password" id="passAccess" placeholder="CODE ACCÈS" class="text-center text-2xl tracking-[10px]" autocomplete="new-password">
        <button onclick="checkLogin()" class="btn-gold mt-4 shadow-xl w-full">OUVRIR LA SESSION</button>
    </div>
</div>

<div id="app" class="hidden">
    <nav class="p-4 glass m-2 flex justify-between items-center sticky top-0 z-50 shadow-lg">
        <div class="flex flex-col leading-none">
            <div class="font-black text-amber-500 uppercase italic flex items-center gap-2">
                <img id="navLogo" src="" style="height: 25px; width: 25px; object-fit: contain; border-radius: 4px;"> 
                EKELEC <span class="text-[9px] bg-amber-500/20 px-2 py-1 rounded text-amber-200">V9.9.9</span>
            </div>
            <span id="displayGerant" class="text-[9px] font-black uppercase text-slate-400 mt-1 opacity-70">GÉRANT : </span>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="openModal('modalCode')" title="Changer le Code" class="text-amber-500 text-xl"><i class="fa-solid fa-key"></i></button>
            <button onclick="exportData()" title="Sauvegarder" class="text-blue-400 text-xl"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            <input type="file" id="importFile" onchange="importData()" class="hidden">
            <button onclick="document.getElementById('importFile').click()" title="Importer" class="text-yellow-400 text-xl"><i class="fa-solid fa-upload"></i></button>
            <button onclick="location.reload()" class="text-red-500 text-xl"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div class="p-4 max-w-6xl mx-auto">
        <div id="viewAccueil">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-[10px] font-black uppercase tracking-[3px] text-slate-500">Tableau de bord</h2>
                <button onclick="printGlobalReport()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase flex items-center gap-2 border border-slate-500">
                    <i class="fa-solid fa-print"></i> Bilan Global
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-4 border-b-4 border-blue-500"><p class="text-[9px] uppercase font-black text-slate-400">Projets</p><p id="statTotalChantiers" class="text-2xl font-black text-white">0</p></div>
                <div class="glass p-4 border-b-4 border-emerald-500"><p class="text-[9px] uppercase font-black text-slate-400">Total Reçu</p><p id="statTotalRecu" class="text-xl font-black text-emerald-400">0 GNF</p></div>
                <div class="glass p-4 border-b-4 border-red-500"><p class="text-[9px] uppercase font-black text-slate-400">Total Dépensé</p><p id="statTotalDepense" class="text-xl font-black text-red-400">0 GNF</p></div>
                <div class="glass p-4 border-b-4 border-amber-500"><p class="text-[9px] uppercase font-black text-slate-400">Solde Global</p><p id="statTotalSolde" class="text-xl font-black text-amber-500">0 GNF</p></div>
            </div>
            <div class="flex justify-between items-center mb-6 gap-4">
                <input type="text" id="searchHome" oninput="renderHome()" placeholder="Rechercher..." class="max-w-xs mb-0" autocomplete="off">
                <button onclick="openModal('modalChantier')" class="bg-amber-500 text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">+ Nouveau Projet</button>
            </div>
            <div id="listeChantiers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewProjet" class="hidden">
            <button onclick="goHome()" class="text-slate-400 mb-6 text-[10px] font-black uppercase flex items-center gap-2 hover:text-white transition"><i class="fa-solid fa-chevron-left"></i> Retour</button>
            <div class="glass p-8 mb-6 border-l-[12px] border-amber-500 shadow-2xl relative">
                <h1 id="chantierTitre" class="text-3xl font-black text-amber-500 uppercase italic leading-none mb-2"></h1>
                <p id="chantierInfos" class="text-[11px] opacity-60 font-bold uppercase mb-6"></p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="openSaisie()" class="bg-emerald-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg">Nouvelle Saisie</button>
                    <button onclick="printReport()" class="bg-blue-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg">Imprimer Rapport</button>
                </div>
                <div class="absolute right-8 top-8 text-right">
                    <p class="text-[10px] uppercase font-black opacity-30">Solde Caisse</p>
                    <p id="soldeChantier" class="text-4xl font-black text-emerald-400">0 GNF</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 glass p-5">
                    <h3 class="text-[11px] font-black text-amber-500 uppercase mb-5">Suivi Personnel</h3>
                    <div id="listeOuvriers" class="space-y-4"></div>
                </div>
                <div class="lg:col-span-3 glass overflow-hidden">
                    <div class="overflow-x-auto"> <table class="w-full text-left text-[11px]">
                            <thead class="bg-slate-800 text-slate-400 font-black uppercase">
                                <tr><th class="p-5">Opération</th><th class="p-5">Entrée</th><th class="p-5">Sortie</th><th class="p-5">Solde</th><th class="p-5 text-center">Gestion</th></tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalCode" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[200] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-amber-500 shadow-2xl">
        <h3 class="font-black mb-6 uppercase text-amber-500 italic text-xl">Changer Code Accès</h3>
        <input type="password" id="newCode" placeholder="NOUVEAU CODE" autocomplete="new-password">
        <button onclick="changeCode()" class="btn-gold w-full mt-4">ENREGISTRER</button>
        <button onclick="closeModal('modalCode')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="modalSaisie" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-amber-500 shadow-2xl overflow-y-auto max-h-[90vh]">
        <h3 class="font-black mb-4 uppercase text-amber-500 italic text-xl">Saisie de Flux</h3>
        <input type="hidden" id="editIndex">
        <label class="text-[10px] font-black uppercase text-slate-400">Type de saisie</label>
        <select id="typeSaisie" onchange="toggleForm()" class="font-bold">
            <option value="DIVERS">DIVERS (Caisse)</option>
            <option value="ARTICLE">ARTICLE (Matériaux)</option>
            <option value="OUVRIER">OUVRIER (Main d'œuvre)</option>
            <option value="LOCATION">LOCATION</option>
        </select>
        <label class="text-[10px] font-black uppercase text-slate-400">Corps de métier / Catégorie</label>
        <select id="fCat" class="font-bold">
            <option value="GENERAL">Général / Divers</option>
            <option value="LOCATAIRE">Locataire</option>
            <option value="DEVIS">Devis</option>
            <option value="PROPRIETAIRE">Propriétaire</option>
            <option value="ELECTRICITE">Électricité</option>
            <option value="PLOMBERIE">Plomberie</option>
            <option value="MACONNERIE">Maçonnerie</option>
            <option value="PEINTURE">Peinture</option>
            <option value="MENUISERIE">Menuiserie</option>
            <option value="FORAGE">Forage</option>
            <option value="CARRELAGE">Carrelage</option>
        </select>
        <div id="formD"><input type="text" id="fMotif" placeholder="Désignation" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="number" id="fE" placeholder="Reçu" autocomplete="off"><input type="number" id="fS" placeholder="Payé" autocomplete="off"></div></div>
        <div id="formA" class="hidden"><input type="text" id="fArtNom" placeholder="Nom article" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="number" id="fArtP" placeholder="Prix Unit." autocomplete="off"><input type="number" id="fArtQ" placeholder="Quantité" autocomplete="off"></div></div>
        <div id="formO" class="hidden"><input type="text" id="fOuvNom" placeholder="Nom ouvrier" autocomplete="off" oninput="trouverOuvrier(this.value)"><input type="text" id="fOuvJob" placeholder="Métier (Ex: Électricien)" autocomplete="off"><input type="number" id="fOuvC" placeholder="Montant Contrat" autocomplete="off"><input type="number" id="fOuvA" placeholder="Paiement" autocomplete="off"></div>
        <div id="formL" class="hidden"><input type="text" id="fLocNom" placeholder="Nom et Prénom" autocomplete="off"><input type="text" id="fLocBat" placeholder="N° de bâtiment" autocomplete="off"><div class="grid grid-cols-2 gap-2"><input type="number" id="fLocRecu" placeholder="Reçu (Montant)" autocomplete="off"><input type="number" id="fLocPaye" placeholder="Payé (Sortie)" autocomplete="off"></div><input type="text" id="fLocMois" placeholder="Le(s) mois payé(s)" autocomplete="off"></div>
        <input type="date" id="fDate">
        <div class="grid grid-cols-2 gap-3 mt-6"><button onclick="saveEntry(true)" class="bg-emerald-600 text-white font-black rounded-lg text-[10px] uppercase p-4">Suivant</button><button onclick="saveEntry(false)" class="btn-gold">VALIDER</button></div>
        <button onclick="closeModal('modalSaisie')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="modalChantier" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-amber-500 shadow-2xl">
        <h3 id="chantierModalTitre" class="font-black mb-6 uppercase text-amber-500 italic text-xl">Nouveau Projet</h3>
        <input type="hidden" id="editChantierIndex"><input type="text" id="cNom" placeholder="NOM DU CHANTIER" autocomplete="off"><input type="text" id="cLieu" placeholder="LOCALISATION" autocomplete="off"><input type="text" id="cClient" placeholder="NOM DU CLIENT" autocomplete="off">
        <button id="btnCreateChantier" onclick="createChantier()" class="btn-gold shadow-2xl w-full mt-4">CRÉER</button>
        <button onclick="closeModal('modalChantier')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="printArea"><div id="printContent"></div></div>

<script>
let currentLogo = localStorage.getItem('EKELEC_LOGO') || "https://via.placeholder.com/120?text=LOGO";
document.getElementById('logoPreview').src = currentLogo;
document.getElementById('navLogo').src = currentLogo; 

function previewImage(input) {
    if (input.files && input.files[0]) {
        let reader = new FileReader();
        reader.onload = function(e) {
            currentLogo = e.target.result;
            document.getElementById('logoPreview').src = currentLogo;
            document.getElementById('navLogo').src = currentLogo;
            localStorage.setItem('EKELEC_LOGO', currentLogo);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

let db = JSON.parse(localStorage.getItem('PRO_DB_V9')) || [];
let config = JSON.parse(localStorage.getItem('PRO_CONFIG')) || { code: "1234" };
let currentId = null;

function saveDB() { localStorage.setItem('PRO_DB_V9', JSON.stringify(db)); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
function goHome() { document.getElementById('viewAccueil').classList.remove('hidden'); document.getElementById('viewProjet').classList.add('hidden'); renderHome(); }
function openProject(i) { currentId = i; document.getElementById('viewAccueil').classList.add('hidden'); document.getElementById('viewProjet').classList.remove('hidden'); document.getElementById('chantierTitre').innerText = db[i].nom; document.getElementById('chantierInfos').innerText = `${db[i].lieu || ''} | CLIENT: ${db[i].client || 'N/A'}`; renderJournal(); }
function validerParEntree() { if (!document.getElementById('loginPage').classList.contains('hidden')) { checkLogin(); } }

function checkLogin(){
    const gerant = document.getElementById('userGerant').value;
    const pass = document.getElementById('passAccess').value;
    if(pass === config.code && gerant.trim() !== "") {
        document.getElementById('displayGerant').innerText = "GÉRANT : " + gerant.toUpperCase();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderHome();
    } else { alert("CODE INCORRECT"); }
}

function changeCode() {
    const n = document.getElementById('newCode').value;
    if(n.length >= 4) { config.code = n; localStorage.setItem('PRO_CONFIG', JSON.stringify(config)); alert("CODE MODIFIÉ"); closeModal('modalCode'); } else { alert("MINIMUM 4 CHIFFRES"); }
}

function toggleForm() {
    const t = document.getElementById('typeSaisie').value;
    document.getElementById('formD').classList.toggle('hidden', t !== 'DIVERS');
    document.getElementById('formA').classList.toggle('hidden', t !== 'ARTICLE');
    document.getElementById('formO').classList.toggle('hidden', t !== 'OUVRIER');
    document.getElementById('formL').classList.toggle('hidden', t !== 'LOCATION');
}

function openSaisie() { viderSaisie(); document.getElementById('fDate').valueAsDate = new Date(); openModal('modalSaisie'); }

function ajouterAcompteRapide(nom, job, contrat) {
    viderSaisie();
    document.getElementById('typeSaisie').value = "OUVRIER";
    toggleForm();
    document.getElementById('fOuvNom').value = nom;
    document.getElementById('fOuvJob').value = job;
    document.getElementById('fOuvC').value = contrat;
    document.getElementById('fDate').valueAsDate = new Date();
    openModal('modalSaisie');
}

function renderHome(){
    const div = document.getElementById('listeChantiers');
    const search = document.getElementById('searchHome').value.toLowerCase();
    div.innerHTML = ""; let gRecu = 0, gDepense = 0;
    db.forEach((c,i)=>{
        let inT=0, outT=0; c.flux.forEach(f=>{ inT+=f.e; outT+=f.s; });
        let soldeP = inT - outT;
        gRecu += inT; gDepense += outT;
        if(c.nom.toLowerCase().includes(search)){
            div.innerHTML += `<div class="glass p-6 relative cursor-pointer border-b-4 border-transparent hover:border-amber-500" onclick="openProject(${i})">
                <h3 class="text-xl font-black text-amber-500 uppercase italic">${c.nom}</h3>
                <div class="mt-4 space-y-1">
                    <div class="flex justify-between text-[10px] font-black"><span>REÇU:</span><span class="text-emerald-400">${inT.toLocaleString()} GNF</span></div>
                    <div class="flex justify-between text-[10px] font-black"><span>SORTIE:</span><span class="text-red-400">${outT.toLocaleString()} GNF</span></div>
                    <div class="flex justify-between text-[10px] font-black pt-1 border-t border-slate-700/50"><span>SOLDE:</span><span class="text-amber-500">${soldeP.toLocaleString()} GNF</span></div>
                </div>
                <div class="absolute top-4 right-4 flex gap-3">
                    <button onclick="editProject(event, ${i})" class="text-blue-400 hover:text-blue-300"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteProject(event, ${i})" class="text-slate-700 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        }
    });
    document.getElementById('statTotalChantiers').innerText = db.length;
    document.getElementById('statTotalRecu').innerText = gRecu.toLocaleString() + " GNF";
    document.getElementById('statTotalDepense').innerText = gDepense.toLocaleString() + " GNF";
    document.getElementById('statTotalSolde').innerText = (gRecu-gDepense).toLocaleString() + " GNF";
}

function renderJournal(){
    const c = db[currentId]; const tbody = document.getElementById('tableBody'); const lOuv = document.getElementById('listeOuvriers');
    tbody.innerHTML = ""; lOuv.innerHTML = ""; let workers = {}; let runningSolde = 0;
    c.flux.forEach((f,idx)=>{
        runningSolde += (f.e - f.s);
        if(f.type==='OUVRIER'){
            if(!workers[f.on]) workers[f.on]={job:f.oj, contrat:f.oc, paye:0};
            workers[f.on].paye += f.s;
        }
        tbody.innerHTML += `<tr><td class="p-5 font-bold uppercase">${f.txt}<br><span class="opacity-30 text-[9px] mr-2">${f.date}</span> <span class="text-[8px] bg-slate-700 px-2 py-0.5 rounded text-amber-500">${f.cat || 'GENERAL'}</span></td><td class="p-5 text-emerald-400 font-black">${f.e>0?f.e.toLocaleString():'-'}</td><td class="p-5 text-red-400 font-black">${f.s>0?f.s.toLocaleString():'-'}</td><td class="p-5 font-black text-white">${runningSolde.toLocaleString()}</td><td class="p-5 text-center flex gap-4 justify-center"><button onclick="editEntry(${idx})" class="text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteEntry(${idx})" class="text-slate-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
    });
    document.getElementById('soldeChantier').innerText = runningSolde.toLocaleString() + " GNF";
    for(let n in workers){
        let r = workers[n].contrat - workers[n].paye;
        lOuv.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-xl border-l-4 border-amber-500">
            <div class="flex justify-between mb-2">
                <div class="flex items-center gap-2">
                    <button onclick="ajouterAcompteRapide('${n.replace(/'/g, "\\'")}', '${workers[n].job.replace(/'/g, "\\'")}', ${workers[n].contrat})" class="text-emerald-500 hover:scale-125 transition" title="Ajouter un acompte">
                        <i class="fa-solid fa-circle-plus"></i>
                    </button>
                    <span class="font-black text-[10px] uppercase">${n}</span>
                </div>
                <div class="flex gap-2"><button onclick="printRecu('${n.replace(/'/g, "\\'")}')" class="text-white opacity-40 hover:opacity-100 text-xs"><i class="fa-solid fa-print"></i></button></div>
            </div>
            <div class="flex justify-between items-end"><span class="text-[9px] opacity-30">RESTE</span><span class="font-black text-xs ${r<=0?'text-emerald-400':'text-red-400'}">${r.toLocaleString()} GNF</span></div></div>`;
    }
}

function saveEntry(keepOpen) {
    const idx = document.getElementById('editIndex').value; 
    const type = document.getElementById('typeSaisie').value;
    let entry = { type: type, date: document.getElementById('fDate').value, cat: document.getElementById('fCat').value, e: 0, s: 0, txt: "", oc: 0, on: "", oj: "", locBat: "", locMois: "" };
    if(type === 'DIVERS') { 
        entry.e = parseFloat(document.getElementById('fE').value) || 0; 
        entry.s = parseFloat(document.getElementById('fS').value) || 0; 
        entry.txt = document.getElementById('fMotif').value || "Divers"; 
        if(entry.e === 0 && entry.s === 0 && entry.txt === "Divers") { alert("SAISIE VIDE !"); return; }
    }
    else if(type === 'ARTICLE') { 
        let p = parseFloat(document.getElementById('fArtP').value) || 0, q = parseFloat(document.getElementById('fArtQ').value) || 0; 
        let nomArt = document.getElementById('fArtNom').value;
        if(!nomArt || (p*q === 0)) { alert("NOM OU PRIX MANQUANT !"); return; }
        entry.s = p * q; entry.txt = `ARTICLE : ${nomArt.toUpperCase()} (x${q})`; 
    }
    else if(type === 'OUVRIER') { 
        entry.on = document.getElementById('fOuvNom').value.trim(); 
        entry.oj = document.getElementById('fOuvJob').value; 
        entry.oc = parseFloat(document.getElementById('fOuvC').value) || 0; 
        entry.s = parseFloat(document.getElementById('fOuvA').value) || 0; 
        if(!entry.on) { alert("NOM OUVRIER MANQUANT !"); return; }
        entry.txt = `PAYE : ${entry.on.toUpperCase()}`; 
    }
    else if(type === 'LOCATION') {
        const nom = document.getElementById('fLocNom').value.toUpperCase();
        const bat = document.getElementById('fLocBat').value;
        const mois = document.getElementById('fLocMois').value;
        entry.e = parseFloat(document.getElementById('fLocRecu').value) || 0;
        entry.s = parseFloat(document.getElementById('fLocPaye').value) || 0;
        if(!nom || (entry.e === 0 && entry.s === 0)) { alert("NOM OU MONTANT MANQUANT !"); return; }
        entry.locBat = bat; entry.locMois = mois;
        entry.txt = `LOCATION : ${nom} (BAT: ${bat}) - MOIS: ${mois}`;
    }
    if(idx !== "") db[currentId].flux[idx] = entry; else db[currentId].flux.push(entry);
    saveDB(); renderJournal();
    if(keepOpen) { viderSaisie(); document.getElementById('fDate').valueAsDate = new Date(); } else { closeModal('modalSaisie'); }
}

function viderSaisie() {
    document.querySelectorAll('#modalSaisie input').forEach(i => i.value = "");
    document.getElementById('editIndex').value = "";
    document.getElementById('fCat').value = "GENERAL";
    document.getElementById('typeSaisie').value = "DIVERS";
    toggleForm();
}

function deleteEntry(idx) { if(confirm("Supprimer cette ligne ?")) { db[currentId].flux.splice(idx, 1); saveDB(); renderJournal(); } }

function editProject(e, i) {
    e.stopPropagation();
    const c = db[i];
    document.getElementById('editChantierIndex').value = i;
    document.getElementById('cNom').value = c.nom;
    document.getElementById('cLieu').value = c.lieu;
    document.getElementById('cClient').value = c.client;
    document.getElementById('chantierModalTitre').innerText = "Modifier Projet";
    document.getElementById('btnCreateChantier').innerText = "METTRE À JOUR";
    openModal('modalChantier');
}

function createChantier() { 
    const n = document.getElementById('cNom').value; 
    const idx = document.getElementById('editChantierIndex').value;
    if(n) { 
        if(idx !== "") {
            db[idx].nom = n;
            db[idx].lieu = document.getElementById('cLieu').value;
            db[idx].client = document.getElementById('cClient').value;
        } else {
            db.push({ nom: n, lieu: document.getElementById('cLieu').value, client: document.getElementById('cClient').value, flux: [] }); 
        }
        saveDB(); closeModal('modalChantier'); renderHome(); 
    } 
}

function deleteProject(e, i) { 
    e.stopPropagation(); 
    const codeCheck = prompt("SÉCURITÉ : Entrez le CODE ACCÈS pour supprimer ce projet :");
    if(codeCheck === config.code) { if(confirm("Confirmer définitivement la suppression ?")) { db.splice(i,1); saveDB(); renderHome(); } }
}

function printReport() { 
    const c = db[currentId]; let ti = 0, to = 0, soldeCaisse = 0; let ouvriersSuivi = {}; 
    const gerant = document.getElementById('userGerant').value.toUpperCase(); 
    let h = `<div style="padding:30px; background:#fff; color:#000">
        <div class="report-header">
            <div class="info-block">
                <h1 class="report-title">RAPPORT D'ACTIVITÉ</h1>
                <span class="info-line">PROJET : <b>${c.nom.toUpperCase()}</b></span>
                <span class="info-line">CLIENT : <b>${c.client.toUpperCase() || 'N/A'}</b></span>
            </div>
            <div class="info-block" style="text-align:right;">
                <span class="info-line">LIEU : <b>${c.lieu.toUpperCase() || 'N/A'}</b></span>
                <span class="info-line">GÉRANT : <b>${gerant}</b></span>
                <span class="info-line">DATE : <b>${new Date().toLocaleDateString()}</b></span>
            </div>
        </div>
        <table><thead><tr><th>DATE</th><th>LIBELLÉ (CATÉGORIE)</th><th>ENTRÉE</th><th>SORTIE</th><th>SOLDE</th></tr></thead><tbody>`; 
    c.flux.forEach((f) => { 
        ti += f.e; to += f.s; soldeCaisse += (f.e - f.s); 
        let sortieTxt = f.s > 0 ? f.s.toLocaleString() : '-'; 
        if(f.type === 'OUVRIER') { 
            if(!ouvriersSuivi[f.on]) ouvriersSuivi[f.on] = 0; 
            ouvriersSuivi[f.on] += f.s; 
            sortieTxt = `<b>${f.s.toLocaleString()}</b> <span style="font-size:8px">(Reste: ${(f.oc - ouvriersSuivi[f.on]).toLocaleString()})</span>`; 
        } 
        h += `<tr><td>${f.date}</td><td><b>${f.txt}</b> <span class="cat-badge">${f.cat || 'GENERAL'}</span></td><td style="text-align:right">${f.e>0?f.e.toLocaleString():'-'}</td><td style="text-align:right">${sortieTxt}</td><td style="text-align:right; background:#f8fafc"><b>${soldeCaisse.toLocaleString()}</b></td></tr>`; 
    }); 
    h += `</tbody></table><div class="total-box total-depense-rouge">TOTAL DÉPENSÉ : ${to.toLocaleString()} GNF</div><div class="total-box">SOLDE NET EN CAISSE : ${(ti-to).toLocaleString()} GNF</div></div>`; 
    document.getElementById('printContent').innerHTML = h; window.print(); 
}

function printGlobalReport() { 
    let gRecu = 0, gDepense = 0; const gerant = document.getElementById('userGerant').value.toUpperCase(); 
    let h = `<div style="padding:30px; color:#000; background:#fff">
        <div class="report-header">
            <div>
                <h1 class="report-title">BILAN GÉNÉRAL</h1>
                <p class="info-line">GÉRANT : <b>${gerant}</b></p>
            </div>
            <div style="text-align:right"><p class="info-line">DATE : ${new Date().toLocaleDateString()}</p></div>
        </div>
        <table><thead><tr><th>CHANTIER</th><th>CLIENT</th><th>REÇU</th><th>DÉPENSÉ</th><th>SOLDE</th></tr></thead><tbody>`; 
    db.forEach(c => { 
        let inT=0, outT=0; c.flux.forEach(f=>{ inT+=f.e; outT+=f.s; }); 
        gRecu += inT; gDepense += outT; 
        h += `<tr><td><b>${c.nom.toUpperCase()}</b></td><td>${c.client || '-'}</td><td style="text-align:right">${inT.toLocaleString()}</td><td style="text-align:right">${outT.toLocaleString()}</td><td style="text-align:right"><b>${(inT-outT).toLocaleString()}</b></td></tr>`; 
    }); 
    h += `</tbody></table><div class="total-box total-depense-rouge">TOTAL DÉPENSÉ : ${gDepense.toLocaleString()} GNF</div><div class="total-box">SOLDE GLOBAL : ${(gRecu-gDepense).toLocaleString()} GNF</div></div>`; 
    document.getElementById('printContent').innerHTML = h; window.print(); 
}

function printRecu(nomOuvrier) {
    const c = db[currentId];
    const gerant = document.getElementById('userGerant').value.toUpperCase();
    let totalPaye = 0, contrat = 0, metier = "";
    let lignes = c.flux.filter(f => f.type === 'OUVRIER' && f.on === nomOuvrier);
    if (lignes.length > 0) { contrat = lignes[0].oc; metier = lignes[0].oj; }
    let h = `<div style="padding:30px; color:#000; background:#fff">
        <div class="report-header">
            <div>
                <h1 class="report-title recu-ouvrier-title">REÇU DE PAIEMENT</h1>
                <p class="info-line">OUVRIER : <b>${nomOuvrier.toUpperCase()}</b> (${metier})</p>
                <p class="info-line">PROJET : <b>${c.nom.toUpperCase()}</b></p>
            </div>
            <div style="text-align:right"><p class="info-line">DATE : <b>${new Date().toLocaleDateString()}</b></p></div>
        </div>
        <table><thead><tr><th>DATE</th><th>DÉSIGNATION</th><th>MONTANT REÇU</th></tr></thead><tbody>`;
    lignes.forEach(l => {
        totalPaye += l.s;
        h += `<tr><td>${l.date}</td><td>Acompte / Paiement</td><td style="text-align:right">${l.s.toLocaleString()} GNF</td></tr>`;
    });
    h += `</tbody></table>
        <div class="total-box">CONTRAT : ${contrat.toLocaleString()} GNF</div>
        <div class="total-box">TOTAL DÉJÀ PAYÉ : ${totalPaye.toLocaleString()} GNF</div>
        <div class="total-box" style="border-top: 3px solid #000">RESTE À PAYER : ${(contrat - totalPaye).toLocaleString()} GNF</div>
        <div style="margin-top:40px; display:flex; justify-content:space-between; font-size:11px">
            <p style="text-decoration:underline">Signature Ouvrier</p>
            <p style="text-decoration:underline">Signature Gérant (${gerant})</p>
        </div>
    </div>`;
    document.getElementById('printContent').innerHTML = h; window.print();
}

function editEntry(idx) { 
    const f = db[currentId].flux[idx]; 
    document.getElementById('editIndex').value = idx; 
    document.getElementById('typeSaisie').value = f.type; 
    document.getElementById('fCat').value = f.cat || 'GENERAL'; 
    toggleForm(); 
    document.getElementById('fDate').value = f.date; 
    if(f.type==='DIVERS'){ document.getElementById('fMotif').value=f.txt; document.getElementById('fE').value=f.e; document.getElementById('fS').value=f.s; } 
    else if(f.type==='ARTICLE'){ 
        document.getElementById('fArtNom').value=f.txt.replace('ARTICLE : ','').split(' (')[0]; 
        let parts = f.txt.match(/\(x(\d+)\)/); let q = parts ? parseInt(parts[1]) : 1;
        document.getElementById('fArtQ').value = q; document.getElementById('fArtP').value = f.s / q;
    } else if(f.type==='OUVRIER'){
        document.getElementById('fOuvNom').value = f.on; document.getElementById('fOuvJob').value = f.oj;
        document.getElementById('fOuvC').value = f.oc; document.getElementById('fOuvA').value = f.s;
    } else if(f.type==='LOCATION'){
        document.getElementById('fLocNom').value = f.txt.replace('LOCATION : ', '').split(' (')[0];
        document.getElementById('fLocBat').value = f.locBat; document.getElementById('fLocMois').value = f.locMois;
        document.getElementById('fLocRecu').value = f.e; document.getElementById('fLocPaye').value = f.s;
    }
    openModal('modalSaisie');
}

function trouverOuvrier(nom) {
    if(!nom || nom.length < 2) return;
    for(let p of db) {
        let f = p.flux.find(x => x.type === 'OUVRIER' && x.on.toLowerCase().includes(nom.toLowerCase()));
        if(f) { document.getElementById('fOuvJob').value = f.oj; document.getElementById('fOuvC').value = f.oc; break; }
    }
}

function exportData() {
    const data = JSON.stringify({db, config, logo: currentLogo});
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'EKELEC_SAVE.json'; a.click();
}

function importData() {
    const file = document.getElementById('importFile').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            db = data.db; config = data.config;
            if(data.logo) { currentLogo = data.logo; localStorage.setItem('EKELEC_LOGO', currentLogo); }
            saveDB(); localStorage.setItem('PRO_CONFIG', JSON.stringify(config));
            location.reload();
        } catch(e) { alert("ERREUR IMPORT"); }
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
