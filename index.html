<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHANTIER PRO V9 - PREMIUM</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
.glass { background: #1e293b; border: 1px solid #334155; border-radius: 20px; transition:0.3s; }
input, select { background: #0f172a !important; border: 1px solid #475569 !important; color: white !important; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; outline: none; }
.btn-gold { background: #f59e0b; color: black; font-weight: bold; text-transform: uppercase; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.3s; border:none; }
.btn-gold:hover { background: #fbbf24; transform: translateY(-2px); }

#printArea { display: none; }
@media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; padding: 0; }
    .report-header { border-bottom: 4px solid #f59e0b; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
    .report-title { font-size: 28px; font-weight: 900; text-transform: uppercase; color: #000; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th { background: #f8fafc !important; border: 1px solid #000; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; }
    td { border: 1px solid #e2e8f0; padding: 10px; font-size: 11px; color: #000 !important; }
    .total-box { border: 2px solid #000; padding: 15px; margin-top: 20px; text-align: right; font-size: 18px; font-weight: 900; background: #f8fafc !important; }
    .signature-grid { display: grid; grid-cols: 2; margin-top: 50px; gap: 50px; }
    .sig-box { border-top: 1px dashed #000; padding-top: 10px; text-align: center; font-size: 10px; font-weight: bold; text-transform: uppercase; }
}
</style>
</head>
<body>

<div id="loginPage" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-950">
    <div class="glass p-10 w-full max-w-md text-center shadow-2xl">
        <h1 class="text-4xl font-black text-amber-500 mb-6 italic uppercase tracking-tighter">Pro-Chantier</h1>
        <input type="password" id="passAccess" placeholder="CODE ACCÈS" class="text-center text-2xl tracking-[10px]">
        <button onclick="checkLogin()" class="btn-gold mt-4 shadow-xl w-full">OUVRIR LA SESSION</button>
    </div>
</div>

<div id="app" class="hidden">
    <nav class="p-4 glass m-2 flex justify-between items-center sticky top-0 z-50 shadow-lg">
        <div class="font-black text-amber-500 uppercase italic flex items-center gap-2">
            <i class="fa-solid fa-helmet-safety"></i> PRO-CHANTIER <span class="text-[9px] bg-amber-500/20 px-2 py-1 rounded text-amber-200">V9 GOLD</span>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="exportData()" title="Backup" class="text-blue-400 text-xl"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            <input type="file" id="importFile" onchange="importData()" class="hidden">
            <button onclick="document.getElementById('importFile').click()" title="Import" class="text-yellow-400 text-xl"><i class="fa-solid fa-upload"></i></button>
            <button onclick="location.reload()" class="text-red-500 text-xl"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div class="p-4 max-w-6xl mx-auto">
        <div id="viewAccueil">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black uppercase italic tracking-wider">Tableau de bord</h2>
                <button onclick="openModal('modalChantier')" class="bg-amber-500 text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-amber-400">+ Créer Projet</button>
            </div>
            <div id="listeChantiers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewProjet" class="hidden">
            <button onclick="goHome()" class="text-slate-400 mb-6 text-[10px] font-black uppercase flex items-center gap-2 hover:text-white transition">
                <i class="fa-solid fa-chevron-left"></i> Retour à la liste
            </button>
            
            <div class="glass p-8 mb-6 border-l-[12px] border-amber-500 shadow-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <h1 id="chantierTitre" class="text-3xl font-black text-amber-500 uppercase italic leading-none mb-2"></h1>
                    <p id="chantierInfos" class="text-[11px] opacity-60 font-bold uppercase tracking-widest mb-6"></p>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openSaisie()" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg">Nouvelle Saisie</button>
                        <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg">Générer Rapport PDF</button>
                    </div>
                </div>
                <div class="absolute right-8 top-8 text-right">
                    <p class="text-[10px] uppercase font-black opacity-30">Solde Actuel</p>
                    <p id="soldeChantier" class="text-4xl font-black text-emerald-400">0 FG</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 glass p-5">
                    <h3 class="text-[11px] font-black text-amber-500 uppercase mb-5 flex items-center gap-2">
                        <i class="fa-solid fa-users"></i> Suivi Personnel
                    </h3>
                    <div id="listeOuvriers" class="space-y-4"></div>
                </div>
                <div class="lg:col-span-3 glass overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-[11px]">
                            <thead class="bg-slate-800/50 text-slate-400 font-black uppercase">
                                <tr>
                                    <th class="p-5">Détails Opération</th>
                                    <th class="p-5 text-emerald-400">Entrée (+)</th>
                                    <th class="p-5 text-red-400">Sortie (-)</th>
                                    <th class="p-5 text-center">Gestion</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalSaisie" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-amber-500 shadow-2xl">
        <h3 id="modalSaisieTitre" class="font-black mb-6 uppercase text-amber-500 italic text-xl">Saisie de Flux</h3>
        <input type="hidden" id="editIndex">
        <select id="typeSaisie" onchange="toggleForm()" class="font-bold">
            <option value="DIVERS">DIVERS (Caisse)</option>
            <option value="ARTICLE">ARTICLE (Matériaux)</option>
            <option value="OUVRIER">OUVRIER (Main d'œuvre)</option>
        </select>
        <div id="formD"><input type="text" id="fMotif" placeholder="Désignation"><div class="grid grid-cols-2 gap-2"><input type="number" id="fE" placeholder="Reçu"><input type="number" id="fS" placeholder="Payé"></div></div>
        <div id="formA" class="hidden"><input type="text" id="fArtNom" placeholder="Nom article"><div class="grid grid-cols-2 gap-2"><input type="number" id="fArtP" placeholder="Prix Unit."><input type="number" id="fArtQ" placeholder="Quantité"></div></div>
        <div id="formO" class="hidden"><input type="text" id="fOuvNom" placeholder="Nom ouvrier" oninput="trouverOuvrier(this.value)"><input type="text" id="fOuvJob" placeholder="Métier"><input type="number" id="fOuvC" placeholder="Contrat"><input type="number" id="fOuvA" placeholder="Paiement"></div>
        <input type="date" id="fDate">
        <button onclick="saveEntry()" class="btn-gold mt-6 shadow-2xl w-full">ENREGISTRER [ENTRÉE]</button>
        <button onclick="closeModal('modalSaisie')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black tracking-widest">Fermer sans enregistrer</button>
    </div>
</div>

<div id="modalChantier" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
    <div class="glass p-10 w-full max-w-md border-t-[10px] border-amber-500 shadow-2xl">
        <h3 class="font-black mb-6 uppercase text-amber-500 italic text-xl">Démarrer Projet</h3>
        <input type="text" id="cNom" placeholder="NOM DU CHANTIER">
        <input type="text" id="cLieu" placeholder="LOCALISATION">
        <input type="text" id="cClient" placeholder="NOM DU CLIENT">
        <button onclick="createChantier()" class="btn-gold shadow-2xl w-full mt-4">CRÉER LE DOSSIER</button>
        <button onclick="closeModal('modalChantier')" class="w-full mt-4 text-[10px] opacity-40 uppercase font-black">Annuler</button>
    </div>
</div>

<div id="printArea"><div id="printContent"></div></div>

<script>
let db = JSON.parse(localStorage.getItem('PRO_DB_V9')) || [];
let currentId = null;

// GESTION ENTRÉE
window.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        if (!document.getElementById('loginPage').classList.contains('hidden')) checkLogin();
        else if (document.getElementById('modalChantier').style.display === 'flex') createChantier();
        else if (document.getElementById('modalSaisie').style.display === 'flex') saveEntry();
    }
});

function checkLogin(){
    if(document.getElementById('passAccess').value==="1234") {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderHome();
    } else { alert("ACCÈS REFUSÉ"); }
}

function renderHome(){
    const div = document.getElementById('listeChantiers');
    div.innerHTML = "";
    db.forEach((c,i)=>{
        let inT=0, outT=0; c.flux.forEach(f=>{inT+=f.e; outT+=f.s;});
        div.innerHTML += `
            <div class="group glass p-6 relative cursor-pointer border-b-4 border-transparent hover:border-amber-500 transition-all" onclick="openProject(${i})">
                <h3 class="text-xl font-black text-amber-500 uppercase italic">${c.nom}</h3>
                <p class="text-[10px] opacity-50 mb-4 font-bold tracking-widest">${c.lieu}</p>
                <div class="bg-slate-900/80 p-4 rounded-xl flex justify-between items-center">
                    <span class="text-[10px] font-black uppercase text-slate-500">Caisse</span>
                    <span class="font-black text-lg ${(inT-outT)>=0?'text-emerald-400':'text-red-400'}">${(inT-outT).toLocaleString()} FG</span>
                </div>
                <button onclick="deleteProject(event, ${i})" class="absolute top-4 right-4 text-slate-700 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
            </div>`;
    });
}

function openProject(i){
    currentId = i;
    document.getElementById('viewAccueil').classList.add('hidden');
    document.getElementById('viewProjet').classList.remove('hidden');
    document.getElementById('chantierTitre').innerText = db[i].nom;
    document.getElementById('chantierInfos').innerText = `${db[i].lieu} | CLIENT : ${db[i].client}`;
    renderJournal();
}

function renderJournal(){
    const c = db[currentId];
    const tbody = document.getElementById('tableBody');
    const lOuv = document.getElementById('listeOuvriers');
    tbody.innerHTML = ""; lOuv.innerHTML = "";
    let workers = {}; let solde = 0;
    
    c.flux.forEach((f,idx)=>{
        solde += (f.e - f.s);
        if(f.type==='OUVRIER'){
            if(!workers[f.on]) workers[f.on]={job:f.oj, contrat:f.oc, paye:0};
            workers[f.on].paye += f.s; workers[f.on].contrat = f.oc;
        }
        tbody.innerHTML += `
            <tr class="hover:bg-slate-800/30 transition">
                <td class="p-5 font-bold uppercase">${f.txt}<br><span class="opacity-30 font-medium text-[9px] tracking-widest">${f.date}</span></td>
                <td class="p-5 text-emerald-400 font-black text-sm">${f.e>0?f.e.toLocaleString():'-'}</td>
                <td class="p-5 text-red-400 font-black text-sm">${f.s>0?f.s.toLocaleString():'-'}</td>
                <td class="p-5 text-center flex gap-4 justify-center">
                    <button onclick="editEntry(${idx})" class="text-blue-400 hover:scale-125 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                    <button onclick="deleteEntry(${idx})" class="text-slate-600 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`;
    });
    
    document.getElementById('soldeChantier').innerText = solde.toLocaleString() + " FG";

    for(let n in workers){
        let r = workers[n].contrat - workers[n].paye;
        lOuv.innerHTML += `
            <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 border-l-4 border-l-amber-500 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-black text-amber-500 text-[10px] uppercase">${n}</span>
                    <div class="flex gap-3">
                        <button onclick="sendWA('${n}')" class="text-emerald-500"><i class="fa-brands fa-whatsapp"></i></button>
                        <button onclick="printRecu('${n}')" class="text-white opacity-40 hover:opacity-100"><i class="fa-solid fa-print"></i></button>
                    </div>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-[9px] font-bold opacity-30 uppercase tracking-tighter">Reste à payer</span>
                    <span class="font-black text-xs ${r<=0?'text-emerald-400':'text-red-400'}">${r.toLocaleString()} FG</span>
                </div>
            </div>`;
    }
}

// MODIFICATION
function editEntry(idx) {
    const f = db[currentId].flux[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('typeSaisie').value = f.type;
    toggleForm();
    document.getElementById('fDate').value = f.date;
    if(f.type === 'DIVERS') {
        document.getElementById('fMotif').value = f.txt;
        document.getElementById('fE').value = f.e;
        document.getElementById('fS').value = f.s;
    } else if(f.type === 'ARTICLE') {
        document.getElementById('fArtNom').value = f.txt.replace('ARTICLE : ','').split(' (')[0];
        document.getElementById('fArtP').value = f.s / (parseInt(f.txt.split('x')[1]) || 1);
        document.getElementById('fArtQ').value = parseInt(f.txt.split('x')[1]) || 1;
    } else {
        document.getElementById('fOuvNom').value = f.on;
        document.getElementById('fOuvJob').value = f.oj;
        document.getElementById('fOuvC').value = f.oc;
        document.getElementById('fOuvA').value = f.s;
    }
    document.getElementById('modalSaisieTitre').innerText = "Modifier l'opération";
    openModal('modalSaisie');
}

function saveEntry() {
    const idx = document.getElementById('editIndex').value;
    const type = document.getElementById('typeSaisie').value;
    let entry = { type: type, date: document.getElementById('fDate').value, e: 0, s: 0, txt: "", oc: 0, on: "", oj: "" };
    
    if(type === 'DIVERS') {
        entry.e = parseFloat(document.getElementById('fE').value) || 0;
        entry.s = parseFloat(document.getElementById('fS').value) || 0;
        entry.txt = document.getElementById('fMotif').value || "Divers";
    } else if(type === 'ARTICLE') {
        let p = parseFloat(document.getElementById('fArtP').value) || 0, q = parseFloat(document.getElementById('fArtQ').value) || 0;
        entry.s = p * q;
        entry.txt = `ARTICLE : ${document.getElementById('fArtNom').value.toUpperCase()} (x${q})`;
    } else {
        entry.on = document.getElementById('fOuvNom').value.trim();
        entry.oj = document.getElementById('fOuvJob').value;
        entry.oc = parseFloat(document.getElementById('fOuvC').value) || 0;
        entry.s = parseFloat(document.getElementById('fOuvA').value) || 0;
        entry.txt = `PAYE : ${entry.on.toUpperCase()}`;
    }

    if(idx !== "") db[currentId].flux[idx] = entry;
    else db[currentId].flux.push(entry);
    
    saveDB(); closeModal('modalSaisie'); renderJournal();
}

function printReport() {
    const c = db[currentId]; let ti = 0, to = 0;
    let h = `<div style="padding:40px; color:#000; background:#fff">
        <div class="report-header">
            <div><h1 class="report-title">RAPPORT DE GESTION</h1><p><b>PROJET :</b> ${c.nom.toUpperCase()}</p></div>
            <div style="text-align:right"><p><b>CLIENT :</b> ${c.client}</p><p><b>LIEU :</b> ${c.lieu}</p></div>
        </div>
        <table><thead><tr><th>DATE</th><th>DÉSIGNATION / LIBELLÉ</th><th>ENTRÉE (FG)</th><th>SORTIE (FG)</th></tr></thead><tbody>`;
    c.flux.forEach(f => { ti+=f.e; to+=f.s; h+=`<tr><td>${f.date}</td><td>${f.txt}</td><td>${f.e.toLocaleString()}</td><td>${f.s.toLocaleString()}</td></tr>`; });
    h += `</tbody></table><div class="total-box">SOLDE EN CAISSE : ${(ti-to).toLocaleString()} FG</div>
        <div class="signature-grid" style="display:flex; justify-content:space-between; margin-top:80px">
            <div class="sig-box" style="width:200px">LE GÉRANT (SIGNATURE)</div>
            <div class="sig-box" style="width:200px">LE CLIENT (LU ET APPROUVÉ)</div>
        </div>
    </div>`;
    document.getElementById('printContent').innerHTML = h; window.print();
}

function printRecu(nom) {
    const c = db[currentId]; let ctr = 0, pye = 0, job="";
    c.flux.forEach(f => { if(f.on === nom) { ctr = f.oc; pye += f.s; job=f.oj; } });
    let h = `<div style="padding:50px; border:10px double #000; margin:20px; color:#000; background:#fff">
        <h1 style="text-align:center; font-size:30px; text-decoration:underline">REÇU DE PAIEMENT</h1>
        <div style="margin:40px 0; font-size:16px; line-height:2">
            Je soussigné, <b>${nom.toUpperCase()}</b>, exerçant en tant que <b>${job}</b>,<br>
            reconnaît avoir reçu ce jour un paiement sur le chantier <b>${c.nom.toUpperCase()}</b>.<br><br>
            <b>MONTANT DU CONTRAT :</b> ${ctr.toLocaleString()} FG<br>
            <b>TOTAL PERÇU À CE JOUR :</b> ${pye.toLocaleString()} FG<br>
            <b style="font-size:20px">RESTE À PAYER : ${(ctr-pye).toLocaleString()} FG</b>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:60px">
            <div style="text-align:center"><b>SIGNATURE OUVRIER</b><br><br><br>_________________</div>
            <div style="text-align:center"><b>CACHET DIRECTION</b><br><br><br>_________________</div>
        </div>
    </div>`;
    document.getElementById('printContent').innerHTML = h; window.print();
}

function saveDB() { localStorage.setItem('PRO_DB_V9', JSON.stringify(db)); }
function goHome() { document.getElementById('viewAccueil').classList.remove('hidden'); document.getElementById('viewProjet').classList.add('hidden'); renderHome(); }
function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='modalSaisie' && document.getElementById('editIndex').value==="") viderSaisie(); const inp = document.getElementById(id).querySelector('input'); if(inp) inp.focus(); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('editIndex').value=""; document.getElementById('modalSaisieTitre').innerText="Nouvelle Opération";}
function toggleForm() {
    const v = document.getElementById('typeSaisie').value;
    document.getElementById('formD').className = v === 'DIVERS' ? '' : 'hidden';
    document.getElementById('formA').className = v === 'ARTICLE' ? '' : 'hidden';
    document.getElementById('formO').className = v === 'OUVRIER' ? '' : 'hidden';
}
function trouverOuvrier(nom) {
    const found = db[currentId].flux.find(f => f.on && f.on.toLowerCase() === nom.toLowerCase());
    if(found) { document.getElementById('fOuvJob').value = found.oj; document.getElementById('fOuvC').value = found.oc; }
}
function sendWA(nom) {
    const c = db[currentId]; let ctr = 0, pye = 0; c.flux.forEach(f => { if(f.on === nom) { ctr = f.oc; pye += f.s; } });
    window.open(`https://wa.me/?text=*RECUPERATION CHANTIER* : ${c.nom.toUpperCase()}%0AOuvrier : ${nom.toUpperCase()}%0AReste : ${(ctr-pye).toLocaleString()} FG`, '_blank');
}
function createChantier() {
    const n = document.getElementById('cNom').value;
    if(n) { db.push({ nom: n, lieu: document.getElementById('cLieu').value, client: document.getElementById('cClient').value, flux: [] }); saveDB(); closeModal('modalChantier'); renderHome(); }
}
function deleteProject(e, i) { e.stopPropagation(); if(confirm("Supprimer ce chantier définitivement ?")) { db.splice(i,1); saveDB(); renderHome(); } }
function deleteEntry(idx) { if(confirm("Supprimer cette ligne ?")) { db[currentId].flux.splice(idx,1); saveDB(); renderJournal(); } }
function exportData() {
    const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_pro_v9.json`; a.click();
}
function importData() {
    const file = document.getElementById('importFile').files[0];
    const reader = new FileReader();
    reader.onload = e => { db = JSON.parse(e.target.result); saveDB(); renderHome(); };
    reader.readAsText(file);
}
function openSaisie() { document.getElementById('editIndex').value = ""; openModal('modalSaisie'); }
function viderSaisie() { document.querySelectorAll('#modalSaisie input').forEach(i => i.value=""); document.getElementById('fDate').valueAsDate = new Date(); document.getElementById('modalSaisieTitre').innerText="Nouvelle Opération";}
document.getElementById('fDate').valueAsDate = new Date();
</script>
</body>
</html>
